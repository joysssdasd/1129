# 部署检查清单

## 前置准备

- [ ] 已有 Supabase 账号
- [ ] 已有微信小程序账号
- [ ] 已安装 Node.js 和 npm
- [ ] 已安装微信开发者工具

## 数据库配置

- [ ] 执行 `init-new-project.sql` 创建所有表
- [ ] 确认 `payment_qrcodes` 表有 2 条记录（微信、支付宝）
- [ ] 确认所有表的 RLS 策略已启用

## Storage 配置

- [ ] 创建 `payment-qrcodes` bucket (Public)
- [ ] 创建 `recharge-screenshots` bucket (Public)
- [ ] 上传微信收款二维码 (`wechat-qr.jpg`)
- [ ] 上传支付宝收款二维码 (`alipay-qr.jpg`)
- [ ] 更新 `payment_qrcodes` 表中的 URL

## Edge Functions 部署

- [ ] 运行 `deploy-edge-functions.bat` 或手动部署
- [ ] 确认 6 个函数都部署成功：
  - [ ] wechat-quick-login
  - [ ] view-contact
  - [ ] recharge-request
  - [ ] publish-post
  - [ ] toggle-post-status
  - [ ] process-referral-reward

## Edge Function Secrets

- [ ] 添加 `WECHAT_MINIPROGRAM_APPID` = `wx0414f85654e5815f`
- [ ] 添加 `WECHAT_MINIPROGRAM_SECRET` = (从微信公众平台获取)

## 微信小程序配置

- [ ] 配置服务器域名：`https://hntiihuxqlklpiyqmlob.supabase.co`
  - [ ] request 合法域名
  - [ ] uploadFile 合法域名
  - [ ] downloadFile 合法域名
- [ ] 获取并配置 AppSecret

## 代码配置

- [ ] `.mcp.json` 已更新为新项目
- [ ] `xiaochengxu/miniprogram/app.js` 的 URL 和 Key 已更新
- [ ] `.env.local` 已更新

## 功能测试

### 登录功能
- [ ] 点击"微信一键登录"
- [ ] 授权手机号
- [ ] 成功登录并显示用户信息
- [ ] 新用户显示"赠送100积分"提示

### 充值功能
- [ ] 进入充值页面
- [ ] 显示微信和支付宝收款二维码
- [ ] 可以点击放大查看二维码
- [ ] 选择充值金额
- [ ] 上传付款截图成功
- [ ] 提交充值申请成功

### 发布功能
- [ ] 填写交易信息
- [ ] 提交成功
- [ ] 积分正确扣除（-10）
- [ ] 在"我的发布"中可以看到

### 查看联系方式
- [ ] 点击交易信息进入详情
- [ ] 点击"查看联系方式"
- [ ] 显示风险提示
- [ ] 确认后自动复制联系方式
- [ ] 积分正确扣除（-1）
- [ ] 再次查看不扣费

### 上架/下架功能
- [ ] 在"我的发布"中下架信息
- [ ] 返还剩余积分
- [ ] 重新上架扣除 10 积分

## 验证数据

### 检查用户表
```sql
SELECT id, phone, wechat_id, points, created_at 
FROM users 
ORDER BY created_at DESC 
LIMIT 5;
```

### 检查收款二维码
```sql
SELECT * FROM payment_qrcodes WHERE status = 'active';
```

### 检查充值申请
```sql
SELECT * FROM recharge_requests ORDER BY created_at DESC LIMIT 5;
```

### 检查积分记录
```sql
SELECT * FROM point_transactions ORDER BY created_at DESC LIMIT 10;
```

## 性能检查

- [ ] 首页加载速度 < 2秒
- [ ] 登录响应时间 < 3秒
- [ ] 图片加载正常
- [ ] 无明显卡顿

## 安全检查

- [ ] RLS 策略已启用
- [ ] Edge Functions 使用 Service Role Key
- [ ] 敏感信息不在客户端暴露
- [ ] API Key 正确配置

## 日志检查

- [ ] 查看 Edge Functions 日志无错误
- [ ] 查看 Database 日志无异常
- [ ] 查看 Storage 日志无问题

## 备份

- [ ] 导出数据库 schema
- [ ] 备份 Edge Functions 代码
- [ ] 保存配置文件

## 文档

- [ ] 阅读 `新项目部署指南.md`
- [ ] 阅读 `问题修复总结.md`
- [ ] 保存微信 AppSecret（安全存储）

## 上线前最后检查

- [ ] 所有功能测试通过
- [ ] 无控制台错误
- [ ] 收款二维码正确
- [ ] 用户协议内容正确
- [ ] 联系方式显示正确

## 上线后监控

- [ ] 监控 Edge Functions 调用次数
- [ ] 监控数据库连接数
- [ ] 监控 Storage 使用量
- [ ] 收集用户反馈

---

**完成日期**: ___________

**检查人**: ___________

**备注**: ___________
