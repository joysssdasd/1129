# 新项目部署指南

## 项目信息
- **项目 ID**: `hntiihuxqlklpiyqmlob`
- **项目 URL**: `https://hntiihuxqlklpiyqmlob.supabase.co`
- **区域**: ap-southeast-1 (新加坡)
- **小程序 AppID**: `wx0414f85654e5815f`

## 部署步骤

### 1. 初始化数据库

在 Supabase Dashboard 执行 SQL：

1. 打开 [SQL Editor](https://supabase.com/dashboard/project/hntiihuxqlklpiyqmlob/sql/new)
2. 复制 `init-new-project.sql` 的内容
3. 点击 "Run" 执行

### 2. 创建 Storage Buckets

在 [Storage](https://supabase.com/dashboard/project/hntiihuxqlklpiyqmlob/storage/buckets) 创建以下 buckets：

#### a. payment-qrcodes (收款二维码)
```
名称: payment-qrcodes
公开访问: ✅ Public
文件大小限制: 5MB
允许的文件类型: image/*
```

#### b. recharge-screenshots (充值截图)
```
名称: recharge-screenshots
公开访问: ✅ Public
文件大小限制: 10MB
允许的文件类型: image/*
```

### 3. 部署 Edge Functions

运行部署脚本：

```bash
deploy-edge-functions.bat
```

或手动部署：

```bash
# 登录 Supabase
npx supabase login

# 链接项目
npx supabase link --project-ref hntiihuxqlklpiyqmlob

# 部署函数
npx supabase functions deploy wechat-quick-login --no-verify-jwt
npx supabase functions deploy view-contact --no-verify-jwt
npx supabase functions deploy recharge-request --no-verify-jwt
npx supabase functions deploy publish-post --no-verify-jwt
npx supabase functions deploy toggle-post-status --no-verify-jwt
npx supabase functions deploy process-referral-reward --no-verify-jwt
```

### 4. 配置 Edge Function Secrets

在 [Edge Functions Settings](https://supabase.com/dashboard/project/hntiihuxqlklpiyqmlob/settings/functions) 添加：

| Secret Name | Value |
|------------|-------|
| `WECHAT_MINIPROGRAM_APPID` | `wx0414f85654e5815f` |
| `WECHAT_MINIPROGRAM_SECRET` | (从微信公众平台获取) |

获取小程序密钥：
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 开发 → 开发管理 → 开发设置
3. 复制 AppSecret

### 5. 上传收款二维码

#### 方式一：通过 Dashboard 上传

1. 打开 [Storage - payment-qrcodes](https://supabase.com/dashboard/project/hntiihuxqlklpiyqmlob/storage/buckets/payment-qrcodes)
2. 上传微信收款二维码，命名为 `wechat-qr.jpg`
3. 上传支付宝收款二维码，命名为 `alipay-qr.jpg`

#### 方式二：通过 SQL 更新

上传后，在 SQL Editor 更新数据库：

```sql
UPDATE payment_qrcodes 
SET qr_code_url = 'https://hntiihuxqlklpiyqmlob.supabase.co/storage/v1/object/public/payment-qrcodes/wechat-qr.jpg'
WHERE payment_type = 'wechat';

UPDATE payment_qrcodes 
SET qr_code_url = 'https://hntiihuxqlklpiyqmlob.supabase.co/storage/v1/object/public/payment-qrcodes/alipay-qr.jpg'
WHERE payment_type = 'alipay';
```

### 6. 配置微信小程序

在微信公众平台配置服务器域名：

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 开发 → 开发管理 → 开发设置 → 服务器域名
3. 添加以下域名：

**request 合法域名**:
```
https://hntiihuxqlklpiyqmlob.supabase.co
```

**uploadFile 合法域名**:
```
https://hntiihuxqlklpiyqmlob.supabase.co
```

**downloadFile 合法域名**:
```
https://hntiihuxqlklpiyqmlob.supabase.co
```

### 7. 测试功能

#### 测试登录
1. 打开微信开发者工具
2. 编译并运行小程序
3. 点击"微信一键登录"
4. 授权手机号
5. 检查是否成功登录并显示用户信息

#### 测试充值
1. 进入"充值"页面
2. 检查是否显示收款二维码
3. 选择充值金额
4. 上传付款截图
5. 提交充值申请

#### 测试发布
1. 进入"发布"页面
2. 填写交易信息
3. 提交发布
4. 检查积分是否扣除

#### 测试查看联系方式
1. 在首页点击任意交易信息
2. 点击"查看联系方式"
3. 确认风险提示
4. 检查是否自动复制联系方式

## 常见问题

### Q1: 收款二维码不显示
**解决方案**:
1. 检查 Storage Bucket `payment-qrcodes` 是否创建并设为 Public
2. 检查 `payment_qrcodes` 表是否有数据
3. 检查二维码 URL 是否正确

### Q2: 付款截图上传失败
**解决方案**:
1. 检查 Storage Bucket `recharge-screenshots` 是否创建
2. 检查 Edge Function `recharge-request` 是否部署成功
3. 查看 Edge Function 日志

### Q3: 微信登录失败
**解决方案**:
1. 检查 Edge Function Secrets 是否配置正确
2. 检查微信公众平台的服务器域名配置
3. 检查小程序 AppID 和 AppSecret 是否匹配

### Q4: 查看联系方式显示 NULL
**解决方案**:
1. 检查用户登录时是否正确设置了 `wechat_id`
2. 检查 Edge Function `view-contact` 返回的字段名是否为 `wechat_id`
3. 检查小程序代码中是否正确处理了返回数据

## 部署完成检查清单

- [ ] 数据库表已创建
- [ ] Storage Buckets 已创建（payment-qrcodes, recharge-screenshots）
- [ ] Edge Functions 已部署（6个函数）
- [ ] Edge Function Secrets 已配置
- [ ] 收款二维码已上传
- [ ] 微信小程序服务器域名已配置
- [ ] 登录功能测试通过
- [ ] 充值功能测试通过
- [ ] 发布功能测试通过
- [ ] 查看联系方式功能测试通过

## 下一步

部署完成后，建议：

1. 创建管理员账号（用于审核充值申请）
2. 配置自动过期任务（定时下架过期交易信息）
3. 监控 Edge Function 日志
4. 定期备份数据库

## 技术支持

如有问题，请检查：
- Supabase Dashboard 日志
- Edge Function 日志
- 微信开发者工具控制台
- 浏览器开发者工具网络请求
