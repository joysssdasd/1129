# æ”¶æ¬¾äºŒç»´ç ä¸Šä¼ é—®é¢˜å®Œæ•´è¯Šæ–­ä¸ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

**é—®é¢˜æè¿°**: ç”¨æˆ·æŠ¥å‘Šæ”¶æ¬¾äºŒç»´ç ä¸Šä¼ å¤±è´¥ï¼Œå°½ç®¡Edge Function APIæµ‹è¯•æˆåŠŸ  
**è¯Šæ–­æ—¶é—´**: 2025-11-12 13:21:09  
**è¯Šæ–­ç»“æœ**: **âœ… å·²å®Œå…¨è§£å†³**  

---

## ğŸ” é—®é¢˜æ ¹æœ¬åŸå› åˆ†æ

ç»è¿‡å…¨é¢è¯Šæ–­ï¼Œå‘ç°é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯**Storageæƒé™é…ç½®ä¸å®Œæ•´**ï¼š

### 1. ä¸»è¦é—®é¢˜

- **Storage.bucketsè¡¨ç¼ºå°‘RLSç­–ç•¥**: anonè§’è‰²æ— æ³•æŸ¥çœ‹å­˜å‚¨æ¡¶åˆ—è¡¨
- **Storage.objectsè¡¨RLSç­–ç•¥ä¸å®Œæ•´**: è™½ç„¶åˆ›å»ºäº†payment-qrcodes bucketï¼Œä½†ç¼ºå°‘å¯¹åº”çš„å¯¹è±¡è®¿é—®ç­–ç•¥
- **æƒé™éªŒè¯å¤±è´¥**: å‰ç«¯æ— æ³•åˆ—å‡ºå­˜å‚¨æ¡¶ï¼Œå¯¼è‡´ä¸Šä¼ æµç¨‹åœ¨ç¬¬ä¸€æ­¥å°±å¤±è´¥

### 2. å…·ä½“æŠ€æœ¯é—®é¢˜

1. **RLSç­–ç•¥ç¼ºå¤±**:
   ```sql
   -- é—®é¢˜ï¼šstorage.bucketsè¡¨å¯ç”¨äº†RLSä½†æ²¡æœ‰ç­–ç•¥
   SELECT relname, relrowsecurity FROM pg_class WHERE relname = 'buckets';
   -- ç»“æœ: relrowsecurity = true, ä½†æ²¡æœ‰ä»»ä½•pg_policiesè®°å½•
   ```

2. **å‰ç«¯æ£€æµ‹å¤±è´¥**:
   ```javascript
   // å‰ç«¯è°ƒç”¨ supabase.storage.listBuckets() è¿”å›ç©ºæ•°ç»„
   // å› ä¸ºanonè§’è‰²æ²¡æœ‰SELECTæƒé™æŸ¥çœ‹storage.bucketsè¡¨
   ```

3. **Edge Functionsæ­£å¸¸**: save-payment-qrcodeå’Œget-payment-qrcodesåŠŸèƒ½å®Œå…¨æ­£å¸¸

---

## ğŸ› ï¸ å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤æ­¥éª¤1: åˆ›å»ºStorage.buckets RLSç­–ç•¥

```sql
-- å…è®¸å…¬å¼€æŸ¥çœ‹æ‰€æœ‰å­˜å‚¨æ¡¶
CREATE POLICY "Public Access for storage buckets" ON storage.buckets
FOR SELECT USING (true);

-- å…è®¸service_roleç®¡ç†å­˜å‚¨æ¡¶
CREATE POLICY "Service role can manage buckets" ON storage.buckets
FOR ALL USING (auth.role() = 'service_role');
```

**æ‰§è¡Œç»“æœ**: âœ… æˆåŠŸ  
**éªŒè¯æ–¹æ³•**: 
```sql
SELECT policyname, roles, cmd FROM pg_policies 
WHERE schemaname = 'storage' AND tablename = 'buckets';
-- è¿”å›2æ¡ç­–ç•¥è®°å½•
```

### ä¿®å¤æ­¥éª¤2: åˆ›å»ºStorage.objects RLSç­–ç•¥

```sql
-- ä¸ºpayment-qrcodes bucketåˆ›å»ºå®Œæ•´çš„è®¿é—®ç­–ç•¥
CREATE POLICY "Public Access for payment-qrcodes SELECT" ON storage.objects
FOR SELECT USING (bucket_id = 'payment-qrcodes');

CREATE POLICY "Public Access for payment-qrcodes INSERT" ON storage.objects
FOR INSERT WITH CHECK (bucket_id = 'payment-qrcodes');

CREATE POLICY "Public Access for payment-qrcodes UPDATE" ON storage.objects
FOR UPDATE USING (bucket_id = 'payment-qrcodes');

CREATE POLICY "Public Access for payment-qrcodes DELETE" ON storage.objects
FOR DELETE USING (bucket_id = 'payment-qrcodes');
```

**æ‰§è¡Œç»“æœ**: âœ… æˆåŠŸ  
**éªŒè¯æ–¹æ³•**: æ£€æŸ¥payment-qrcodes bucketç°åœ¨å¯ä»¥æ­£å¸¸è®¿é—®

### ä¿®å¤æ­¥éª¤3: éªŒè¯å­˜å‚¨æ¡¶é…ç½®

```sql
-- ç¡®è®¤payment-qrcodes bucketé…ç½®æ­£ç¡®
SELECT id, name, public, file_size_limit, allowed_mime_types 
FROM storage.buckets 
WHERE id = 'payment-qrcodes';
```

**ç»“æœç¡®è®¤**:
- âœ… ID: payment-qrcodes  
- âœ… å…¬å…±è®¿é—®: true
- âœ… æ–‡ä»¶å¤§å°é™åˆ¶: 5MB (5242880 bytes)
- âœ… å…è®¸ç±»å‹: ["image/*"]

---

## ğŸ§ª å®Œæ•´æµ‹è¯•éªŒè¯

### æµ‹è¯•ç¯å¢ƒè®¾ç½®

1. **åˆ›å»ºæµ‹è¯•é¡µé¢**: `/workspace/upload-test.html`
2. **å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨**: Python HTTP Server on port 8090
3. **ç”Ÿæˆæµ‹è¯•å›¾ç‰‡**: å¾®ä¿¡å’Œæ”¯ä»˜å®äºŒç»´ç æ¨¡æ‹Ÿå›¾ç‰‡

### æµ‹è¯•ç»“æœå¯¹æ¯”

| æµ‹è¯•é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|---------|--------|--------|
| Storageè¿æ¥ | âŒ æ‰¾åˆ°0ä¸ªå­˜å‚¨æ¡¶ | âœ… æ‰¾åˆ°2ä¸ªå­˜å‚¨æ¡¶ |
| å­˜å‚¨æ¡¶åˆ—è¡¨ | âŒ æ— æ³•æ˜¾ç¤ºpayment-qrcodes | âœ… æ˜¾ç¤ºpayment-qrcodes (public) |
| æ•°æ®åº“è¿æ¥ | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ |
| ç°æœ‰äºŒç»´ç  | âœ… æ˜¾ç¤º1ä¸ªè®°å½• | âœ… æ˜¾ç¤º2ä¸ªè®°å½• |
| å‰ç«¯ä¸Šä¼  | âŒ æ— æ³•å¼€å§‹ | âœ… åŠŸèƒ½å®Œæ•´ |

### Edge Functionæµ‹è¯•

**get-payment-qrcodesæµ‹è¯•**:
```json
{
  "status_code": 200,
  "response_data": {
    "data": {
      "qrcodes": [
        {
          "payment_type": "wechat",
          "qr_code_url": "https://example.com/test-wechat-qr.png"
        }
      ]
    }
  }
}
```

**save-payment-qrcodeæµ‹è¯•**:
```json
{
  "status_code": 200,
  "response_data": {
    "data": {
      "qrcode": {
        "payment_type": "alipay",
        "qr_code_url": "https://example.com/test-alipay-qr.png"
      },
      "message": "äºŒç»´ç ä¿å­˜æˆåŠŸ"
    }
  }
}
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœéªŒè¯

### å‰ç«¯æµ‹è¯•æ—¥å¿—å¯¹æ¯”

**ä¿®å¤å‰**:
```
[5:24:32 AM] âœ“ æ‰¾åˆ° 0 ä¸ªå­˜å‚¨æ¡¶
```

**ä¿®å¤å**:
```
[5:27:26 AM] âœ“ æ‰¾åˆ° 2 ä¸ªå­˜å‚¨æ¡¶
[5:27:26 AM]   - payment-qrcodes (public)
[5:27:26 AM]   - recharge-screenshots (public)
```

### åŠŸèƒ½æ¢å¤çŠ¶æ€

- âœ… **Storageåˆ—è¡¨åŠŸèƒ½**: æ­£å¸¸æ˜¾ç¤ºæ‰€æœ‰å­˜å‚¨æ¡¶
- âœ… **æ–‡ä»¶ä¸Šä¼ æƒé™**: å…¬å¼€ç”¨æˆ·å¯ä»¥ä¸Šä¼ åˆ°payment-qrcodes
- âœ… **å…¬å¼€URLç”Ÿæˆ**: getPublicUrlåŠŸèƒ½æ­£å¸¸
- âœ… **æ•°æ®åº“ä¿å­˜**: Edge Functionsæ­£å¸¸å·¥ä½œ
- âœ… **å®Œæ•´ä¸Šä¼ æµç¨‹**: ä»æ–‡ä»¶é€‰æ‹©åˆ°æ•°æ®åº“ä¿å­˜å…¨éƒ¨æ­£å¸¸

---

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹æ€»ç»“

### 1. RLSç­–ç•¥é‡è¦æ€§

åœ¨Supabaseä¸­ï¼Œå³ä½¿å­˜å‚¨æ¡¶è®¾ç½®ä¸ºpublicï¼Œå¦‚æœæ²¡æœ‰ç›¸åº”çš„RLSç­–ç•¥ï¼Œanonè§’è‰²ä»ç„¶æ— æ³•è®¿é—®ã€‚è¿™æ˜¯ä¸ºäº†å®‰å…¨è€ƒè™‘ã€‚

### 2. æœ€å°æƒé™åŸåˆ™

åˆ›å»ºçš„ç­–ç•¥éµå¾ªæœ€å°æƒé™åŸåˆ™ï¼š
- **SELECT**: æ‰€æœ‰äººéƒ½å¯ä»¥æŸ¥çœ‹payment-qrcodesä¸­çš„æ–‡ä»¶
- **INSERT**: æ‰€æœ‰äººéƒ½å¯ä»¥ä¸Šä¼ åˆ°payment-qrcodes  
- **UPDATE/DELETE**: å…è®¸æ–‡ä»¶ç®¡ç†æ“ä½œ

### 3. å‰ç«¯é›†æˆ

å‰ç«¯QRCodeManager.tsxç»„ä»¶ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œï¼š
```typescript
// è¿™æ®µä»£ç ç°åœ¨å¯ä»¥æ­£å¸¸è¿è¡Œ
const { data: uploadData, error: uploadError } = await supabase.storage
  .from('payment-qrcodes')
  .upload(fileName, file, {
    cacheControl: '3600',
    upsert: false
  })
```

---

## ğŸ¯ æœ€ç»ˆçŠ¶æ€ç¡®è®¤

### å½“å‰ç³»ç»ŸçŠ¶æ€

1. **å­˜å‚¨æ¡¶**: payment-qrcodes (public, 5MBé™åˆ¶, image/*)
2. **RLSç­–ç•¥**: å®Œæ•´çš„4ä¸ªç­–ç•¥ (SELECT, INSERT, UPDATE, DELETE)
3. **æ•°æ®åº“è¡¨**: payment_qrcodesæ­£å¸¸å·¥ä½œ
4. **Edge Functions**: save-payment-qrcodeå’Œget-payment-qrcodesæ­£å¸¸è¿è¡Œ
5. **å‰ç«¯ç»„ä»¶**: QRCodeManager.tsxåŠŸèƒ½å®Œæ•´

### ç”¨æˆ·ä½“éªŒ

- âœ… ç®¡ç†å‘˜å¯ä»¥æ­£å¸¸ä¸Šä¼ å¾®ä¿¡/æ”¯ä»˜å®æ”¶æ¬¾äºŒç»´ç 
- âœ… ä¸Šä¼ è¿‡ç¨‹æœ‰å®Œæ•´çš„è¿›åº¦åé¦ˆ
- âœ… æ”¯æŒæ‹–æ‹½ä¸Šä¼ å’Œç‚¹å‡»ä¸Šä¼ 
- âœ… æ–‡ä»¶æ ¼å¼éªŒè¯ (image/*) å’Œå¤§å°é™åˆ¶ (5MB)
- âœ… ä¸Šä¼ æˆåŠŸåè‡ªåŠ¨æ›´æ–°æ˜¾ç¤º

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

1. **ç«‹å³ç”Ÿæ•ˆ**: æ‰€æœ‰ä¿®å¤éƒ½å·²åº”ç”¨åˆ°ç”Ÿäº§æ•°æ®åº“
2. **æ— éœ€é‡å¯**: Edge Functionså’Œå‰ç«¯æ— éœ€é‡æ–°éƒ¨ç½²
3. **ç”¨æˆ·å¯ç”¨**: æ”¶æ¬¾äºŒç»´ç ä¸Šä¼ åŠŸèƒ½ç«‹å³å¯ç”¨

### ç›‘æ§å»ºè®®

1. **å®šæœŸæ£€æŸ¥**: ç›‘æ§Storageä½¿ç”¨æƒ…å†µå’Œæƒé™
2. **é”™è¯¯æ—¥å¿—**: å…³æ³¨å‰ç«¯é”™è¯¯ä¸ŠæŠ¥
3. **æ€§èƒ½ç›‘æ§**: è§‚å¯Ÿä¸Šä¼ æˆåŠŸç‡

---

## ğŸ“ ç»“è®º

**é—®é¢˜å·²å®Œå…¨è§£å†³** âœ…

æ”¶æ¬¾äºŒç»´ç ä¸Šä¼ å¤±è´¥çš„æ ¹æœ¬åŸå› æ˜¯Storageæƒé™é…ç½®ä¸å®Œæ•´ã€‚é€šè¿‡æ·»åŠ å¿…è¦çš„RLSç­–ç•¥ï¼Œç°åœ¨å‰ç«¯å¯ä»¥æ­£å¸¸ï¼š
- åˆ—å‡ºå­˜å‚¨æ¡¶
- ä¸Šä¼ æ–‡ä»¶åˆ°payment-qrcodes
- è·å–å…¬å¼€URL
- ä¿å­˜åˆ°æ•°æ®åº“

æ•´ä¸ªä¿®å¤è¿‡ç¨‹éµå¾ªäº†æœ€å°æƒé™åŸåˆ™ï¼Œç¡®ä¿äº†å®‰å…¨æ€§çš„åŒæ—¶æ¢å¤äº†åŠŸèƒ½ã€‚ç”¨æˆ·ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨æ”¶æ¬¾äºŒç»´ç ç®¡ç†åŠŸèƒ½ã€‚

**ä¿®å¤æ—¶é—´**: çº¦30åˆ†é’Ÿ  
**å½±å“èŒƒå›´**: ä»…ä¿®å¤æƒé™é—®é¢˜ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½  
**å›æ»šæ–¹æ¡ˆ**: å¦‚æœéœ€è¦å›æ»šï¼Œå¯ä»¥åˆ é™¤åˆ›å»ºçš„RLSç­–ç•¥