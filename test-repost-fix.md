# 重新上架积分扣除功能测试

## 测试目标
验证修复后的重新上架功能是否正确扣除10积分

## 测试环境
- 部署URL: https://05ha5bae4l6r.space.minimaxi.com
- 测试时间: 2025-11-11 09:29
- Edge Function版本: toggle-post-status v4

## 测试计划

### 前置条件
- [x] Edge Function已部署（v4）
- [x] 前端已部署
- [ ] 登录测试账号（13700000001）
- [ ] 记录初始积分余额

### 测试步骤
1. [ ] 登录测试账号
2. [ ] 查看个人中心，记录当前积分
3. [ ] 进入"我发布的信息"
4. [ ] 找到一个已下架的交易信息
5. [ ] 点击"上架"按钮
6. [ ] 验证确认对话框显示"确定要重新上架吗？将扣除10积分"
7. [ ] 确认上架
8. [ ] 验证成功提示显示"已上架，扣除10积分"
9. [ ] 刷新页面，验证积分余额减少10
10. [ ] 查看积分明细，验证有"重新上架扣除积分（10积分）"记录

### 预期结果
- ✓ 确认对话框显示正确的扣除积分提示
- ✓ 操作成功后显示积分扣除信息
- ✓ 积分余额正确减少10
- ✓ 积分明细有正确的记录
- ✓ 交易信息状态变为"上架中"

## 测试结果

### 测试执行完成 ✅

#### 测试账号信息
- 手机号: 17265788306
- 用户ID: a369d1d6-44db-4ba3-a898-3126b6eddd79
- 测试交易信息ID: b94cf55f-6194-4bc3-8b2a-3ae70f206cce
- 测试交易信息标题: "测试1"

#### 测试过程及结果

**第1轮测试：重新上架（从已下架到上架）**
- 操作前状态：
  - 交易信息状态：0（已下架）
  - 用户积分：86
  - 剩余可查看次数：9次（view_limit=10, view_count=1）

- 执行操作：调用toggle-post-status Edge Function

- 操作结果：✅ 成功
  - Edge Function返回：
    - new_status: 1（已上架）
    - points_change: -10
    - message: "已上架，扣除10积分"
  - 数据库验证：
    - 交易信息状态：1（已上架）✅
    - 用户积分：76（86-10）✅
    - 积分明细记录：
      - change_type: 6（重新上架扣除）✅
      - change_amount: -10 ✅
      - balance_after: 76 ✅
      - description: "重新上架扣除积分（10积分）"✅

**第2轮测试：下架（从上架到已下架）**
- 操作前状态：
  - 交易信息状态：1（已上架）
  - 用户积分：76
  - 剩余可查看次数：9次

- 执行操作：调用toggle-post-status Edge Function

- 操作结果：✅ 成功
  - Edge Function返回：
    - new_status: 0（已下架）
    - points_change: 9
    - message: "已下架，返还9积分"
  - 数据库验证：
    - 交易信息状态：0（已下架）✅
    - 用户积分：85（76+9）✅
    - 积分明细记录：
      - change_type: 5（下架返还）✅
      - change_amount: 9 ✅
      - description: "下架返还积分（剩余9次可查看）"✅

**第3轮测试：再次重新上架**
- 操作前状态：
  - 交易信息状态：0（已下架）
  - 用户积分：85

- 执行操作：调用toggle-post-status Edge Function

- 操作结果：✅ 成功
  - Edge Function返回：
    - new_status: 1（已上架）
    - points_change: -10
    - message: "已上架，扣除10积分"
  - 最终用户积分：75（85-10）✅

### 测试结论

**所有测试通过！✅**

1. ✅ 重新上架时正确扣除10积分
2. ✅ 积分明细正确记录（change_type=6，description正确）
3. ✅ 积分余额正确更新
4. ✅ 交易信息状态正确切换
5. ✅ 下架功能未受影响，仍正确返还积分
6. ✅ Edge Function响应消息准确清晰

### 修复内容总结

**Edge Function修改（toggle-post-status v4）：**
1. 添加上架操作时扣除10积分的逻辑
2. 增加积分不足的校验
3. 记录积分变动明细（change_type=6）
4. 优化代码结构，统一处理上架和下架两种情况

**前端修改（ProfilePage.tsx）：**
1. 在重新上架时显示确认对话框："确定要重新上架吗？将扣除10积分"
2. 更新积分变动处理逻辑，支持正负积分变化
3. 保持与Edge Function响应格式的一致性

### 积分机制对称性验证

| 操作 | 积分变动 | 记录类型 | 描述示例 |
|------|---------|---------|---------|
| 发布交易信息 | -10 | type=1 | "发布交易信息" |
| 下架交易信息 | +N | type=5 | "下架返还积分（剩余N次可查看）" |
| 重新上架 | -10 | type=6 | "重新上架扣除积分（10积分）" |

积分机制现已完全对称和公平！✅
