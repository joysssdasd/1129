# 微信群消息自动采集工具 - 使用说明

## 快速开始

### 1. 安装依赖

```bash
cd wechat-collector
pip install -r requirements.txt
```

### 2. 配置

复制配置文件并编辑：

```bash
copy config.example.json config.json
```

编辑 `config.json`，填写以下关键配置：

```json
{
  "wechat": {
    "data_path": "C:\\Users\\你的用户名\\Documents\\WeChat Files"
  },
  "monitor_groups": [
    "你要监控的群名1",
    "你要监控的群名2"
  ],
  "platform": {
    "supabase_url": "你的Supabase项目URL",
    "supabase_anon_key": "你的Supabase API密钥",
    "user_id": "你的管理员用户ID"
  },
  "ai": {
    "deepseek_api_key": "你的DeepSeek API密钥"
  }
}
```

### 3. 运行

双击 `start.bat` 或运行：

```bash
python main.py
```

---

## 配置详解

### wechat 配置

| 字段 | 说明 | 示例 |
|------|------|------|
| data_path | 微信数据目录 | `C:\Users\xxx\Documents\WeChat Files` |
| wxid | 微信ID（可选，自动检测） | `wxid_xxx` |
| db_key | 数据库密钥（可选） | 32字节十六进制字符串 |

### monitor_groups 配置

要监控的群名称列表，支持多个群：

```json
"monitor_groups": [
  "黄牛交流群",
  "票务信息群",
  "白银交易群"
]
```

### platform 配置

| 字段 | 说明 | 获取方式 |
|------|------|----------|
| supabase_url | Supabase项目URL | Supabase控制台 → Settings → API |
| supabase_anon_key | API密钥 | 同上 |
| user_id | 发布者用户ID | 管理后台 → 用户管理 → 复制ID |
| wechat_id | 发布者微信号 | 你的微信号 |

### schedule 配置

| 字段 | 说明 | 默认值 |
|------|------|--------|
| interval_minutes | 采集间隔（分钟） | 60 |
| start_hour | 开始时间（小时） | 8 |
| end_hour | 结束时间（小时） | 23 |

### filter 配置

| 字段 | 说明 | 默认值 |
|------|------|--------|
| keywords | 交易关键词 | ["出", "收", "转", "求", "票", "克", "银"] |
| min_message_length | 最小消息长度 | 10 |
| max_message_length | 最大消息长度 | 2000 |

---

## 命令行参数

```bash
# 正常运行（定时采集）
python main.py

# 只执行一次（测试用）
python main.py --once

# 指定配置文件
python main.py --config my_config.json

# 获取微信密钥帮助
python main.py --get-key
```

---

## 测试解析器

```bash
# 测试简单解析器
python test_parser.py

# 测试AI解析器
python test_parser.py --ai --api-key sk-xxx
```

---

## 常见问题

### Q: 无法读取微信数据库？

A: 可能的原因：
1. 微信正在运行，数据库被锁定 → 关闭微信后重试
2. 数据库路径不正确 → 检查 `data_path` 配置
3. 数据库已加密 → 需要获取解密密钥

### Q: 如何获取数据库密钥？

A: 推荐使用 `pywxdump` 工具：

```bash
pip install pywxdump
wxdump info
```

### Q: AI解析不准确？

A: 可以尝试：
1. 调整 `filter.keywords` 增加更多关键词
2. 修改 `message_parser.py` 中的 prompt
3. 使用简单解析器作为备用

### Q: 如何避免重复发布？

A: 工具内置了两层去重：
1. 消息级去重：相同消息不会重复处理
2. 标题级去重：相同标题24小时内不会重复发布

---

## 日志文件

日志保存在 `logs/` 目录下，按日期分割：

```
logs/
  collector_2026-01-01.log
  collector_2026-01-02.log
  ...
```

---

## 注意事项

⚠️ **风险提示**：
1. 本工具仅供学习研究使用
2. 请遵守微信使用协议
3. 自动化操作可能导致账号风险
4. 发布他人信息请确保合规

---

## 技术支持

如有问题，请检查：
1. 日志文件中的错误信息
2. 配置文件是否正确
3. 网络连接是否正常
