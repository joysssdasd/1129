---
argument-hint: [--preview] [--upload] [--clean] [--help]
description: 处理微信聊天记录JSON文件，提取交易信息，去重后上传Supabase
---

# 微信聊天记录交易信息提取工具

## ⚠️ 数据库发布规则（重要）

### 关键字段说明
| 字段 | 说明 | 正确值 |
|------|------|--------|
| `user_id` | 发布者ID | `33f25311-64d7-4b2a-b000-491a44112d29` (管理员) |
| `trade_type` | 交易类型 | **`2` = 出售**, `1` = 求购 |
| `status` | 状态 | `1` = 上架中 |
| `expire_at` | 过期时间 | `created_at + INTERVAL '3 days'` (3天后自动下架) |
| `view_limit` | 查看次数限制 | `10` |

### 联系方式配置
- 所有交易信息关联管理员账户 `user_id = '33f25311-64d7-4b2a-b000-491a44112d29'`
- 管理员微信号: **`niuniubase`**
- 联系方式通过 `user_id` 关联 `users` 表自动获取

### SQL插入模板
```sql
INSERT INTO posts (user_id, title, keywords, price, trade_type, extra_info, view_limit, view_count, deal_count, status, expire_at) VALUES
('33f25311-64d7-4b2a-b000-491a44112d29', '标题', '关键词', 价格, 2, '补充信息', 10, 0, 0, 1, NOW() + INTERVAL '3 days')
```

### 发布后验证清单
1. ✅ 验证 `trade_type = 2` (出售信息应为2，不是1)
2. ✅ 验证 `expire_at = created_at + 3天` (符合平台3天自动下架规则)
3. ✅ 删除已处理的源JSON文件，避免重复解析

### 修复已上传数据的SQL
```sql
-- 修复trade_type（如果误设为1）
UPDATE posts SET trade_type = 2 WHERE user_id = '33f25311-64d7-4b2a-b000-491a44112d29' AND trade_type = 1;

-- 修复expire_at（设为创建时间+3天）
UPDATE posts SET expire_at = created_at + INTERVAL '3 days' WHERE user_id = '33f25311-64d7-4b2a-b000-491a44112d29';
```

---

这个skill用于处理当前目录下的微信聊天记录JSON文件，从中提取交易信息，整理成标准格式后上传到Supabase数据库。

## 使用方法

```bash
/wechat-trade-parser           # 完整流程：提取 → 审核 → 上传 → 删除
/wechat-trade-parser --preview # 仅预览提取结果，不上传不删除
/wechat-trade-parser --upload  # 跳过审核直接上传（危险操作）
/wechat-trade-parser --clean   # 仅清理已处理的JSON文件
/wechat-trade-parser --help    # 显示帮助信息
```

## 工作流程

### 第一步：读取JSON文件
1. 扫描当前目录下所有 `*.json` 文件
2. 解析JSON结构，提取 `session` 和 `messages` 数据
3. 仅处理 `type: "文本消息"` 的消息

### 第二步：识别交易信息
从文本消息中识别包含交易信息的内容，特征包括：
- 包含价格数字（如：1500、3800、6500等）
- 包含票务/商品关键词（如：出、收、票、场、排、座等）
- 包含日期信息（如：1月10日、10号、1.10等）

### 第三步：提取结构化数据
将识别出的交易信息解析为标准格式：

| 字段 | 说明 | 示例 |
|------|------|------|
| title | 标题（演出名+日期+票档） | 成都F4 1月10日 1880VIP |
| price | 实际成交价格 | 10000 |
| extra_info | 补充信息（座位、返点等） | 前8排，邀请函秒发 |
| trade_type | 交易类型 | sell（出售）/ buy（求购） |

### 第四步：交易类型判断规则

#### 演唱会门票（默认）
- **出售（sell, trade_type=2）**：默认类型，群里基本都是出售信息

#### 纪念钞/纪念币（特殊规则）
| 方向 | 交割期 | 交易类型 | trade_type |
|------|--------|----------|------------|
| 多 | 现货 | 求购 | 1 |
| 空 | 现货 | 出售 | 2 |
| 多 | 有期限(如7天期) | 做多 | 3 |
| 空 | 有期限(如7天期) | 做空 | 4 |

**关键词说明：**
- `多` = 收购方向（看涨）
- `空` = 出售方向（看跌）
- `现货` = 立即交割，无期限
- `7天期/15天期` = 期货交易，有交割期限

### 第五步：去重处理
- **出售信息**：同一标题（title完全一致）只保留**最低价格**
- **求购信息**：同一标题（title完全一致）只保留**最高价格**

### 第六步：人工审核
以表格形式展示提取结果，用户可以：
1. 确认无误，继续上传
2. 指出需要修改的条目
3. 取消操作

### 第七步：上传Supabase
调用Supabase MCP服务，将审核通过的数据上传到数据库。

**注意**：需要先配置Supabase MCP服务，配置方法见下方说明。

### 第八步：清理文件
上传成功后，删除已处理的JSON文件。

---

## 纪念钞/纪念币解析规则

### 消息格式
纪念钞/纪念币的交易消息通常分为两部分：
1. **自然语言描述**（前半部分）- 人类可读的描述
2. **结构化数据**（后半部分）- 机器可解析的格式

### 结构化数据格式
```
商品名称,价格,方向,交割期,备注信息
```

**示例消息：**
```
13收马币15天期，收5000枚马币，互打1元保证金，单个快递1000枚以上
1250出5个工行卡第一批货源闷包
880收工行卡闷包期货50个
7000收交行卡闷包现货，一套5枚的
90收驰跃宏图原价78元的，反打100定价，到货闷包给我，加不了钱
3900出马钞标百不挑号7天期，10刀，不需要给我钱，单号款就可以

马币5000枚,13,多,15天期,互打1元保证金;单快递≥1000枚
工行卡第一批闷包5个,1250,空,现货,第一批货源;闷包
工行卡闷包期货50个,880,多,7天期,期货;闷包
交行卡一套5枚现货,7000,多,现货,一套5枚;闷包
驰跃宏图1枚,90,多,到货即交割,反打100元保证金;不加价;原价78元
马钞标百10刀,3900,空,7天期,不挑号;单号款;无需预付
```

### 解析结果
| 商品名称 | 价格 | 方向 | 交割期 | 交易类型 | trade_type |
|---------|------|------|--------|----------|------------|
| 马币5000枚 | 13 | 多 | 15天期 | 做多 | 3 |
| 工行卡第一批闷包5个 | 1250 | 空 | 现货 | 出售 | 2 |
| 工行卡闷包期货50个 | 880 | 多 | 7天期 | 做多 | 3 |
| 交行卡一套5枚现货 | 7000 | 多 | 现货 | 求购 | 1 |
| 驰跃宏图1枚 | 90 | 多 | 到货即交割 | 求购 | 1 |
| 马钞标百10刀 | 3900 | 空 | 7天期 | 做空 | 4 |

### 常见商品关键词
- **纪念币**：马币、工行卡、交行卡、建行卡、农行卡、中行卡、驰跃宏图
- **纪念钞**：马钞、龙钞、蛇钞、航天钞、冬奥钞、亚运钞
- **单位**：枚、套、刀（10张）、标百（100张连号）
- **包装**：闷包（不拆封原包装）、现货、期货

### 数据库字段映射
| 字段 | 说明 | 纪念币特殊处理 |
|------|------|----------------|
| `trade_type` | 交易类型 | 1=求购, 2=出售, 3=做多, 4=做空 |
| `delivery_days` | 交割天数 | 现货=0, 7天期=7, 15天期=15 |
| `extra_info` | 补充信息 | 包含保证金、备注等 |

---

## 演唱会门票价格解析规则

票务信息中的价格格式多样，以下是常见格式及解析规则：

| 原始格式 | 解析结果 | 说明 |
|----------|----------|------|
| `680×1 1100` | 1100 | 原价680，实际售价1100 |
| `1580的3300` | 3300 | 原价1580，实际售价3300 |
| `380的350` | 350 | 原价380，实际售价350 |
| `1580-3300` | 3300 | 原价1580，实际售价3300 |
| `1880VIP前8排10000` | 10000 | 票档1880VIP，实际售价10000 |
| `480--售罄/3000` | 3000 | 10号售罄，11号3000 |
| `980--4500/4000x1+1` | 4000 | 多个价格取较低的 |

**核心原则**：提取的是**实际成交价格**，不是原价/票面价。

---

## 标题提取规则

标题应包含以下信息（按优先级）：
1. **演出/商品名称**：如"成都F4"、"香港BP"、"刘宇宁"
2. **日期**：如"1月10日"、"10号"
3. **票档/规格**：如"1880VIP"、"看台"、"包厢"
4. **区域**（可选）：如"前8排"、"521区"

**示例**：
- `成都F4 1月10日 1880VIP`
- `香港BP 1月24日 699 525区`
- `成都刘宇宁 1月11日 1580前15排`

---



## AI解析指令

当执行此skill时，Claude应按以下步骤操作：

### 步骤1：扫描文件
```
使用 Glob 工具扫描当前目录下所有 *.json 文件
排除 echotrace 子目录
```

### 步骤2：读取并解析
```
对每个JSON文件：
1. 读取文件内容
2. 解析 session.nickname 获取群名/联系人名
3. 筛选 messages 中 type="文本消息" 的记录
4. 提取 content 字段内容
```

### 步骤3：识别交易信息
```
对每条文本消息，判断是否为交易信息：
- 必须包含数字（价格）
- 应包含票务/商品相关词汇
- 排除纯聊天内容（如"OK"、"好的"、"收到"等）
```

### 步骤4：结构化提取
```
对识别出的交易信息，提取：
- title: 演出名+日期+票档
- price: 实际成交价格（数字）
- extra_info: 座位、返点、备注等补充信息
- trade_type: "sell" 或 "buy"
```

### 步骤5：去重
```
按 title 分组：
- trade_type="sell" 的保留 price 最小的
- trade_type="buy" 的保留 price 最大的
```

### 步骤6：展示审核
```
以Markdown表格形式展示结果：
| 序号 | 标题 | 价格 | 补充信息 | 类型 |
|------|------|------|----------|------|
| 1 | ... | ... | ... | 出售 |

询问用户：
1. 确认上传
2. 修改某条记录
3. 删除某条记录
4. 取消操作
```

### 步骤7：上传数据
```
调用 Supabase MCP 的 insert 功能：
- 表名：trade_info（或用户指定的表名）
- 批量插入所有记录
```

### 步骤8：清理文件
```
上传成功后，删除已处理的JSON文件
（需要用户二次确认）
```

---

## 示例输入输出

### 输入消息示例
```
出成都f4
10号
1880vip前8排10000
1880看台前2排8000
1580的3300
1280的2200
包厢1500
邀请函秒发
```

### 输出结果示例
| 标题 | 价格 | 补充信息 | 类型 |
|------|------|----------|------|
| 成都F4 1月10日 1880VIP | 10000 | 前8排，邀请函秒发 | 出售 |
| 成都F4 1月10日 1880看台 | 8000 | 前2排，邀请函秒发 | 出售 |
| 成都F4 1月10日 1580看台 | 3300 | 邀请函秒发 | 出售 |
| 成都F4 1月10日 1280看台 | 2200 | 邀请函秒发 | 出售 |
| 成都F4 1月10日 包厢 | 1500 | 邀请函秒发 | 出售 |

---

## 注意事项

1. **数据安全**：处理前会备份原始JSON文件（可选）
2. **价格验证**：价格必须为正整数，异常值会标记警告
3. **重复检测**：上传前会检查数据库是否已存在相同记录
4. **错误处理**：单条记录失败不影响其他记录上传
5. **日志记录**：所有操作会记录到日志文件

---

## 常见问题

**Q: 为什么有些消息没有被识别为交易信息？**
A: 消息必须同时包含价格数字和商品/票务相关词汇才会被识别。

**Q: 如何处理多日期的票务信息？**
A: 每个日期会被拆分为独立的记录。

**Q: 价格解析错误怎么办？**
A: 在审核环节可以手动修改价格。

**Q: Supabase连接失败怎么办？**
A: 检查MCP配置是否正确，确保URL和API Key有效。
