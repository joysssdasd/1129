# ç‰›ç‰›åŸºåœ°ç½‘ç«™è‡ªåŠ¨ä¿®å¤æ–¹æ¡ˆ

**ç”Ÿæˆæ—¶é—´**: 2026å¹´1æœˆ14æ—¥ 18:20  
**åŸºäºæ£€æµ‹æŠ¥å‘Š**: ç½‘ç«™è‡ªåŠ¨æ£€æµ‹æŠ¥å‘Š_20260114.md  
**ä¿®å¤æ–¹å¼**: è‡ªåŠ¨åŒ–è„šæœ¬ + æ‰‹åŠ¨ç¡®è®¤

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆæ€»è§ˆ

| é—®é¢˜ | ä¼˜å…ˆçº§ | ä¿®å¤æ—¶é—´ | è‡ªåŠ¨åŒ–ç¨‹åº¦ |
|------|--------|----------|------------|
| RLSç­–ç•¥åŠ å¼º | ğŸ”´ é«˜ | 2å°æ—¶ | åŠè‡ªåŠ¨ |
| åˆ›å»ºuser_activityè¡¨ | ğŸŸ¡ ä¸­ | 30åˆ†é’Ÿ | å…¨è‡ªåŠ¨ |
| å‡½æ•°search_pathè®¾ç½® | ğŸŸ¢ ä½ | 1å°æ—¶ | å…¨è‡ªåŠ¨ |
| å¯ç”¨å¯†ç æ³„éœ²ä¿æŠ¤ | ğŸŸ¢ ä½ | 15åˆ†é’Ÿ | æ‰‹åŠ¨ |

---

## ä¿®å¤1: åˆ›å»ºuser_activityè¡¨ (å…¨è‡ªåŠ¨)

### SQLè¿ç§»è„šæœ¬

```sql
-- åˆ›å»ºç”¨æˆ·æ´»åŠ¨è®°å½•è¡¨
CREATE TABLE IF NOT EXISTS public.user_activity (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    activity_type VARCHAR(50) NOT NULL, -- 'login', 'post_create', 'post_view', 'recharge'
    activity_data JSONB,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX idx_user_activity_user_id ON public.user_activity(user_id);
CREATE INDEX idx_user_activity_created_at ON public.user_activity(created_at DESC);
CREATE INDEX idx_user_activity_type ON public.user_activity(activity_type);

-- å¯ç”¨RLS
ALTER TABLE public.user_activity ENABLE ROW LEVEL SECURITY;

-- RLSç­–ç•¥ï¼šç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ´»åŠ¨
CREATE POLICY "ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰æ´»åŠ¨"
ON public.user_activity
FOR SELECT
TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM public.users
        WHERE users.id = auth.uid()
        AND users.is_admin = true
    )
);

-- RLSç­–ç•¥ï¼šç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ´»åŠ¨
CREATE POLICY "ç”¨æˆ·æŸ¥çœ‹è‡ªå·±çš„æ´»åŠ¨"
ON public.user_activity
FOR SELECT
TO authenticated
USING (user_id = auth.uid());

-- RLSç­–ç•¥ï¼šç³»ç»Ÿå¯ä»¥æ’å…¥æ´»åŠ¨è®°å½•
CREATE POLICY "ç³»ç»Ÿæ’å…¥æ´»åŠ¨è®°å½•"
ON public.user_activity
FOR INSERT
TO authenticated
WITH CHECK (true);

-- æ·»åŠ æ³¨é‡Š
COMMENT ON TABLE public.user_activity IS 'ç”¨æˆ·æ´»åŠ¨è®°å½•è¡¨ï¼Œç”¨äºæ•°æ®åˆ†æå’Œå®¡è®¡';
COMMENT ON COLUMN public.user_activity.activity_type IS 'æ´»åŠ¨ç±»å‹ï¼šlogin, post_create, post_view, recharge';
COMMENT ON COLUMN public.user_activity.activity_data IS 'æ´»åŠ¨è¯¦ç»†æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰';
```

### è‡ªåŠ¨æ‰§è¡Œå‘½ä»¤

```bash
# ä½¿ç”¨Supabase CLIæ‰§è¡Œè¿ç§»
supabase migration new create_user_activity_table
# å°†ä¸Šè¿°SQLå¤åˆ¶åˆ°ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶ä¸­
supabase db push
```

---

## ä¿®å¤2: åŠ å¼ºRLSç­–ç•¥ (åŠè‡ªåŠ¨)

### é—®é¢˜åˆ†æ
å½“å‰24ä¸ªè¡¨ä½¿ç”¨`USING (true)`ç­–ç•¥ï¼Œå…è®¸ä»»ä½•äººæ— é™åˆ¶è®¿é—®ã€‚éœ€è¦æ ¹æ®ä¸šåŠ¡é€»è¾‘å®æ–½ç»†ç²’åº¦æƒé™æ§åˆ¶ã€‚

### ä¿®å¤ç­–ç•¥

#### 2.1 ç”¨æˆ·è¡¨ (users)

```sql
-- åˆ é™¤ç°æœ‰çš„è¿‡äºå®½æ¾çš„ç­–ç•¥
DROP POLICY IF EXISTS "enable_all_users" ON public.users;

-- æ–°ç­–ç•¥ï¼šç”¨æˆ·å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„å…¬å¼€ä¿¡æ¯
CREATE POLICY "ç”¨æˆ·æŸ¥çœ‹å…¬å¼€ä¿¡æ¯"
ON public.users
FOR SELECT
TO authenticated
USING (true);

-- æ–°ç­–ç•¥ï¼šç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„ä¿¡æ¯
CREATE POLICY "ç”¨æˆ·æ›´æ–°è‡ªå·±ä¿¡æ¯"
ON public.users
FOR UPDATE
TO authenticated
USING (id = auth.uid())
WITH CHECK (id = auth.uid());

-- æ–°ç­–ç•¥ï¼šç®¡ç†å‘˜å¯ä»¥æ›´æ–°æ‰€æœ‰ç”¨æˆ·
CREATE POLICY "ç®¡ç†å‘˜æ›´æ–°ç”¨æˆ·"
ON public.users
FOR UPDATE
TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM public.users
        WHERE users.id = auth.uid()
        AND users.is_admin = true
    )
);

-- æ–°ç­–ç•¥ï¼šç¦æ­¢æ™®é€šç”¨æˆ·åˆ é™¤
CREATE POLICY "ç¦æ­¢åˆ é™¤ç”¨æˆ·"
ON public.users
FOR DELETE
TO authenticated
USING (false);
```

#### 2.2 äº¤æ˜“ä¿¡æ¯è¡¨ (posts)

```sql
-- åˆ é™¤ç°æœ‰ç­–ç•¥
DROP POLICY IF EXISTS "enable_all_posts" ON public.posts;

-- æ–°ç­–ç•¥ï¼šæ‰€æœ‰äººå¯ä»¥æŸ¥çœ‹ä¸Šæ¶çš„ä¿¡æ¯
CREATE POLICY "æŸ¥çœ‹ä¸Šæ¶ä¿¡æ¯"
ON public.posts
FOR SELECT
TO authenticated
USING (status = 1);

-- æ–°ç­–ç•¥ï¼šç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå·±çš„ä¿¡æ¯
CREATE POLICY "ç”¨æˆ·åˆ›å»ºä¿¡æ¯"
ON public.posts
FOR INSERT
TO authenticated
WITH CHECK (user_id = auth.uid());

-- æ–°ç­–ç•¥ï¼šç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„ä¿¡æ¯
CREATE POLICY "ç”¨æˆ·æ›´æ–°è‡ªå·±ä¿¡æ¯"
ON public.posts
FOR UPDATE
TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());

-- æ–°ç­–ç•¥ï¼šç®¡ç†å‘˜å¯ä»¥æ›´æ–°æ‰€æœ‰ä¿¡æ¯
CREATE POLICY "ç®¡ç†å‘˜æ›´æ–°ä¿¡æ¯"
ON public.posts
FOR UPDATE
TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM public.users
        WHERE users.id = auth.uid()
        AND users.is_admin = true
    )
);

-- æ–°ç­–ç•¥ï¼šç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±çš„ä¿¡æ¯
CREATE POLICY "ç”¨æˆ·åˆ é™¤è‡ªå·±ä¿¡æ¯"
ON public.posts
FOR DELETE
TO authenticated
USING (user_id = auth.uid());
```

#### 2.3 å……å€¼ç”³è¯·è¡¨ (recharge_requests)

```sql
-- åˆ é™¤ç°æœ‰ç­–ç•¥
DROP POLICY IF EXISTS "enable_all_recharge_requests" ON public.recharge_requests;

-- æ–°ç­–ç•¥ï¼šç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„å……å€¼ç”³è¯·
CREATE POLICY "ç”¨æˆ·æŸ¥çœ‹è‡ªå·±å……å€¼"
ON public.recharge_requests
FOR SELECT
TO authenticated
USING (user_id = auth.uid());

-- æ–°ç­–ç•¥ï¼šç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å……å€¼ç”³è¯·
CREATE POLICY "ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰å……å€¼"
ON public.recharge_requests
FOR SELECT
TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM public.users
        WHERE users.id = auth.uid()
        AND users.is_admin = true
    )
);

-- æ–°ç­–ç•¥ï¼šç”¨æˆ·å¯ä»¥åˆ›å»ºå……å€¼ç”³è¯·
CREATE POLICY "ç”¨æˆ·åˆ›å»ºå……å€¼ç”³è¯·"
ON public.recharge_requests
FOR INSERT
TO authenticated
WITH CHECK (user_id = auth.uid());

-- æ–°ç­–ç•¥ï¼šåªæœ‰ç®¡ç†å‘˜å¯ä»¥æ›´æ–°å……å€¼çŠ¶æ€
CREATE POLICY "ç®¡ç†å‘˜å®¡æ ¸å……å€¼"
ON public.recharge_requests
FOR UPDATE
TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM public.users
        WHERE users.id = auth.uid()
        AND users.is_admin = true
    )
);
```

#### 2.4 å…¶ä»–è¡¨çš„RLSç­–ç•¥

```sql
-- point_transactions: ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ç§¯åˆ†è®°å½•
DROP POLICY IF EXISTS "enable_all_point_transactions" ON public.point_transactions;

CREATE POLICY "ç”¨æˆ·æŸ¥çœ‹è‡ªå·±ç§¯åˆ†è®°å½•"
ON public.point_transactions
FOR SELECT
TO authenticated
USING (user_id = auth.uid());

CREATE POLICY "ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰ç§¯åˆ†è®°å½•"
ON public.point_transactions
FOR SELECT
TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM public.users
        WHERE users.id = auth.uid()
        AND users.is_admin = true
    )
);

-- view_history: ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æµè§ˆå†å²
DROP POLICY IF EXISTS "enable_all_view_history" ON public.view_history;

CREATE POLICY "ç”¨æˆ·æŸ¥çœ‹è‡ªå·±æµè§ˆå†å²"
ON public.view_history
FOR ALL
TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());

-- announcements: æ‰€æœ‰äººå¯ä»¥æŸ¥çœ‹ï¼Œåªæœ‰ç®¡ç†å‘˜å¯ä»¥ç®¡ç†
DROP POLICY IF EXISTS "announcements_insert" ON public.announcements;
DROP POLICY IF EXISTS "announcements_update" ON public.announcements;
DROP POLICY IF EXISTS "announcements_delete" ON public.announcements;

CREATE POLICY "æ‰€æœ‰äººæŸ¥çœ‹å…¬å‘Š"
ON public.announcements
FOR SELECT
TO authenticated
USING (is_active = true);

CREATE POLICY "ç®¡ç†å‘˜ç®¡ç†å…¬å‘Š"
ON public.announcements
FOR ALL
TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM public.users
        WHERE users.id = auth.uid()
        AND users.is_admin = true
    )
)
WITH CHECK (
    EXISTS (
        SELECT 1 FROM public.users
        WHERE users.id = auth.uid()
        AND users.is_admin = true
    )
);
```

### æ‰§è¡Œæ­¥éª¤

1. **å¤‡ä»½å½“å‰ç­–ç•¥**
```bash
# å¯¼å‡ºå½“å‰æ•°æ®åº“ç»“æ„
supabase db dump --schema public > backup_before_rls_fix.sql
```

2. **åˆ›å»ºè¿ç§»æ–‡ä»¶**
```bash
supabase migration new fix_rls_policies
```

3. **åº”ç”¨è¿ç§»**
```bash
supabase db push
```

4. **æµ‹è¯•éªŒè¯**
- æµ‹è¯•æ™®é€šç”¨æˆ·æƒé™
- æµ‹è¯•ç®¡ç†å‘˜æƒé™
- æµ‹è¯•åŒ¿åè®¿é—®

---

## ä¿®å¤3: å‡½æ•°search_pathè®¾ç½® (å…¨è‡ªåŠ¨)

### ä¿®å¤è„šæœ¬

```sql
-- ä¿®å¤æ‰€æœ‰å‡½æ•°çš„search_path
ALTER FUNCTION public.tg_set_updated_at() 
SET search_path = public, pg_temp;

ALTER FUNCTION public.generate_unique_invite_code() 
SET search_path = public, pg_temp;

ALTER FUNCTION public.tg_profiles_before_insert() 
SET search_path = public, pg_temp;

ALTER FUNCTION public.tg_profiles_after_insert() 
SET search_path = public, pg_temp;

ALTER FUNCTION public.tg_point_transactions_before_insert() 
SET search_path = public, pg_temp;

ALTER FUNCTION public.tg_posts_search_vector() 
SET search_path = public, pg_temp;
```

### è‡ªåŠ¨æ‰§è¡Œ

```bash
supabase migration new fix_function_search_path
# å°†ä¸Šè¿°SQLå¤åˆ¶åˆ°è¿ç§»æ–‡ä»¶
supabase db push
```

---

## ä¿®å¤4: å¯ç”¨å¯†ç æ³„éœ²ä¿æŠ¤ (æ‰‹åŠ¨)

### æ“ä½œæ­¥éª¤

1. ç™»å½•Supabase Dashboard
2. è¿›å…¥é¡¹ç›®è®¾ç½® â†’ Authentication â†’ Password Settings
3. å¯ç”¨ "Leaked Password Protection"
4. ä¿å­˜è®¾ç½®

### é…ç½®è¯´æ˜
- ä½¿ç”¨HaveIBeenPwned.org APIæ£€æŸ¥å¯†ç 
- ä¸ä¼šå­˜å‚¨æˆ–å‘é€ç”¨æˆ·å¯†ç 
- ä»…æ£€æŸ¥å¯†ç å“ˆå¸Œçš„å‰5ä½
- æå‡ç”¨æˆ·è´¦æˆ·å®‰å…¨æ€§

---

## ğŸš€ ä¸€é”®ä¿®å¤è„šæœ¬

### åˆ›å»ºä¿®å¤è„šæœ¬

```bash
#!/bin/bash
# auto-fix-website.sh
# è‡ªåŠ¨ä¿®å¤ç‰›ç‰›åŸºåœ°ç½‘ç«™é—®é¢˜

echo "ğŸ”§ å¼€å§‹è‡ªåŠ¨ä¿®å¤..."

# 1. åˆ›å»ºuser_activityè¡¨
echo "ğŸ“ åˆ›å»ºuser_activityè¡¨..."
supabase migration new create_user_activity_table
cat > supabase/migrations/$(ls -t supabase/migrations | head -1) << 'EOF'
-- åˆ›å»ºç”¨æˆ·æ´»åŠ¨è®°å½•è¡¨
CREATE TABLE IF NOT EXISTS public.user_activity (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    activity_type VARCHAR(50) NOT NULL,
    activity_data JSONB,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_user_activity_user_id ON public.user_activity(user_id);
CREATE INDEX idx_user_activity_created_at ON public.user_activity(created_at DESC);
CREATE INDEX idx_user_activity_type ON public.user_activity(activity_type);

ALTER TABLE public.user_activity ENABLE ROW LEVEL SECURITY;
EOF

# 2. ä¿®å¤å‡½æ•°search_path
echo "ğŸ”’ ä¿®å¤å‡½æ•°search_path..."
supabase migration new fix_function_search_path
cat > supabase/migrations/$(ls -t supabase/migrations | head -1) << 'EOF'
ALTER FUNCTION public.tg_set_updated_at() SET search_path = public, pg_temp;
ALTER FUNCTION public.generate_unique_invite_code() SET search_path = public, pg_temp;
ALTER FUNCTION public.tg_profiles_before_insert() SET search_path = public, pg_temp;
ALTER FUNCTION public.tg_profiles_after_insert() SET search_path = public, pg_temp;
ALTER FUNCTION public.tg_point_transactions_before_insert() SET search_path = public, pg_temp;
ALTER FUNCTION public.tg_posts_search_vector() SET search_path = public, pg_temp;
EOF

# 3. åº”ç”¨è¿ç§»
echo "âš¡ åº”ç”¨æ•°æ®åº“è¿ç§»..."
supabase db push

echo "âœ… è‡ªåŠ¨ä¿®å¤å®Œæˆï¼"
echo "âš ï¸  è¯·æ‰‹åŠ¨å®Œæˆä»¥ä¸‹æ“ä½œï¼š"
echo "1. åœ¨Supabase Dashboardå¯ç”¨å¯†ç æ³„éœ²ä¿æŠ¤"
echo "2. å®¡æŸ¥å¹¶åº”ç”¨RLSç­–ç•¥ä¿®å¤ï¼ˆéœ€è¦ä¸šåŠ¡é€»è¾‘ç¡®è®¤ï¼‰"
```

---

## ğŸ“‹ ä¿®å¤åéªŒè¯æ¸…å•

### æ•°æ®åº“éªŒè¯
- [ ] user_activityè¡¨å·²åˆ›å»º
- [ ] æ‰€æœ‰ç´¢å¼•å·²åˆ›å»º
- [ ] RLSç­–ç•¥å·²æ›´æ–°
- [ ] å‡½æ•°search_pathå·²è®¾ç½®

### åŠŸèƒ½éªŒè¯
- [ ] æ•°æ®åˆ†æé¡µé¢æ­£å¸¸æ˜¾ç¤ºæ´»è·ƒç”¨æˆ·
- [ ] æ™®é€šç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
- [ ] ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰æ•°æ®
- [ ] å¯†ç æ³„éœ²ä¿æŠ¤å·²å¯ç”¨

### æ€§èƒ½éªŒè¯
- [ ] APIå“åº”æ—¶é—´æ­£å¸¸
- [ ] æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½æ­£å¸¸
- [ ] å‰ç«¯åŠ è½½é€Ÿåº¦æ­£å¸¸

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœä¿®å¤åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å›æ»šï¼š

```bash
# å›æ»šåˆ°ä¸Šä¸€ä¸ªè¿ç§»
supabase db reset

# æˆ–è€…æ¢å¤å¤‡ä»½
psql -h db.hntiihuxqlklpiyqmlob.supabase.co \
     -U postgres \
     -d postgres \
     < backup_before_rls_fix.sql
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨ä¿®å¤è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š
1. æŸ¥çœ‹Supabaseæ—¥å¿—
2. æ£€æŸ¥è¿ç§»æ–‡ä»¶è¯­æ³•
3. éªŒè¯æ•°æ®åº“è¿æ¥
4. è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ

---

**ä¿®å¤æ–¹æ¡ˆç”Ÿæˆ**: è‡ªåŠ¨åŒ–ç³»ç»Ÿ  
**æœ€åæ›´æ–°**: 2026å¹´1æœˆ14æ—¥ 18:20  
**ç‰ˆæœ¬**: 1.0
