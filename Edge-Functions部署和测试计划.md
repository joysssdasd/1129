# Edge Functions部署和测试计划

## 一、待部署的Edge Functions

### 1. toggle-post-status
**功能**：切换交易信息状态并处理积分返还
**路径**：/workspace/supabase/functions/toggle-post-status/index.ts
**状态**：代码已准备，等待部署

**核心逻辑**：
- 验证用户权限
- 查询交易信息当前状态
- 下架时（status: 1→0）：
  - 计算返还积分 = view_count
  - 更新用户积分
  - 记录point_transactions（change_type: 5）
- 更新posts状态
- 返回操作结果

### 2. recharge-request (更新版)
**功能**：充值申请（新积分套餐）
**路径**：/workspace/supabase/functions/recharge-request/index.ts
**状态**：代码已更新，等待部署

**更新内容**：
- 积分计算逻辑：50→55, 100→115, 300→370, 500→650
- 充值档位：50/100/300/500元
- 错误提示更新

## 二、部署步骤

### 步骤1：刷新Token
```
等待协调员调用 ask_for_refresh_supabase_auth_token
```

### 步骤2：批量部署
```typescript
batch_deploy_edge_functions({
  functions: [
    {
      slug: "toggle-post-status",
      file_path: "/workspace/supabase/functions/toggle-post-status/index.ts",
      type: "normal",
      description: "切换交易信息状态并处理积分返还"
    },
    {
      slug: "recharge-request",
      file_path: "/workspace/supabase/functions/recharge-request/index.ts",
      type: "normal",
      description: "充值申请（更新积分套餐）"
    }
  ]
})
```

### 步骤3：验证部署
- 检查函数是否成功部署
- 测试函数是否可访问

## 三、功能测试计划

### 测试环境
- URL: https://jr6ejz51qmcb.space.minimaxi.com
- 测试账号1: 13011319329 (管理员, 验证码: 666666)
- 测试账号2: 13700000001 (普通用户, 密码: test123)

### 测试路径1：积分返还机制
**前置条件**：
- 用户已登录
- 用户已发布至少1条交易信息
- 该信息已被其他用户查看至少1次

**测试步骤**：
1. 登录普通用户账号
2. 进入个人中心 → 我的发布
3. 记录当前积分数量
4. 查看某条信息的view_count（例如：5次）
5. 点击"下架"按钮
6. 验证提示信息：显示"已下架，返还X积分"
7. 检查积分是否增加（应增加view_count数量）
8. 进入积分明细
9. 验证是否有"下架返还"记录

**预期结果**：
- ✅ 提示信息准确显示返还积分
- ✅ 积分余额正确增加
- ✅ 积分明细有记录
- ✅ 记录描述为"下架返还积分（X次查看）"

### 测试路径2：新充值套餐
**前置条件**：
- 管理员账号已设置收款二维码

**测试步骤**：
1. 登录普通用户账号
2. 进入个人中心 → 充值积分
3. 验证充值档位选项：50/100/300/500元
4. 验证积分显示：55/115/370/650积分
5. 验证赠送提示：赠送5/15/70/150积分
6. 选择50元档位
7. 上传测试截图
8. 提交充值申请
9. 切换到管理员账号
10. 进入管理后台 → 充值审核
11. 找到刚才的申请
12. 验证显示：50元 → 55积分
13. 审核通过
14. 切换回普通用户
15. 验证积分增加55

**预期结果**：
- ✅ 充值档位正确显示
- ✅ 积分计算准确（1元=1积分+赠送）
- ✅ 管理员审核界面显示正确
- ✅ 审核通过后积分准确到账

### 测试路径3：快捷交易按钮
**前置条件**：
- 用户已登录
- 用户有至少2积分
- 首页有可用的交易信息

**测试步骤**：
1. 登录普通用户账号
2. 记录当前积分（例如：100积分）
3. 在首页找到一条未查看过的交易信息
4. 点击绿色"交易"按钮
5. 验证弹出提示：显示交易方式
6. 验证剪贴板：复制成功
7. 检查积分变化：减少1积分（99积分）
8. 再次点击同一条信息的"交易"按钮
9. 验证：免费复制，积分不变
10. 将积分设置为0（需要管理员操作）
11. 验证按钮状态：变灰，无法点击
12. 点击按钮验证提示："积分不足，请先充值"

**预期结果**：
- ✅ 首次点击扣除1积分
- ✅ 交易方式成功复制
- ✅ 再次点击免费
- ✅ 积分不足时按钮禁用
- ✅ 提示信息准确

### 测试路径4：下拉刷新（移动端）
**前置条件**：
- 使用移动设备或浏览器移动模式

**测试步骤**：
1. 打开首页
2. 滚动到页面顶部
3. 向下拉动屏幕
4. 验证刷新指示器出现
5. 继续拉动至提示"松开刷新"
6. 松开手指
7. 验证显示"刷新中..."和旋转动画
8. 等待刷新完成
9. 验证交易列表更新
10. 验证用户积分更新

**预期结果**：
- ✅ 拉动时显示指示器
- ✅ 距离足够时提示变化
- ✅ 刷新动画正常
- ✅ 数据成功刷新

### 测试路径5：查看历史入口
**前置条件**：
- 用户已登录
- 用户已查看过至少1条交易信息

**测试步骤**：
1. 登录普通用户账号
2. 进入个人中心
3. 验证快捷功能区有"查看历史"按钮
4. 点击"查看历史"按钮
5. 验证显示查看历史列表
6. 点击某条历史记录
7. 验证跳转到对应的交易详情

**预期结果**：
- ✅ 查看历史入口存在
- ✅ 历史记录正确显示
- ✅ 跳转功能正常

### 测试路径6：首页UI优化
**测试步骤**：
1. 打开首页
2. 统计单屏显示的交易信息数量
3. 验证是否达到7条以上
4. 检查卡片间距是否合理
5. 检查文字清晰度
6. 测试按钮点击区域

**预期结果**：
- ✅ 单屏显示7+条信息
- ✅ 视觉清晰舒适
- ✅ 触摸操作准确

## 四、Edge Function单元测试

### toggle-post-status测试
```bash
# 测试用例1：下架有查看记录的信息
curl -X POST \
  https://mgyelmyjeidlvmmmjkqi.supabase.co/functions/v1/toggle-post-status \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <ANON_KEY>" \
  -d '{
    "user_id": "<USER_ID>",
    "post_id": "<POST_ID>"
  }'

# 预期响应：
{
  "data": {
    "new_status": 0,
    "refund_points": 5,
    "message": "已下架，返还5积分"
  }
}
```

### recharge-request测试
```bash
# 测试用例：提交50元充值申请
curl -X POST \
  https://mgyelmyjeidlvmmmjkqi.supabase.co/functions/v1/recharge-request \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <ANON_KEY>" \
  -d '{
    "user_id": "<USER_ID>",
    "amount": 50,
    "screenshot_data": "data:image/jpeg;base64,..."
  }'

# 预期响应：
{
  "data": {
    "request": {...},
    "message": "充值申请已提交，请等待管理员审核"
  }
}
```

## 五、性能测试

### 响应时间测试
- toggle-post-status：目标 < 1000ms
- recharge-request：目标 < 2000ms（含文件上传）
- 首页加载：目标 < 2000ms
- 下拉刷新：目标 < 1000ms

### 并发测试
- 模拟10个用户同时点击快捷交易按钮
- 验证积分扣除准确性
- 验证无重复扣除

## 六、回归测试

### 已有功能验证
- [ ] 用户注册流程
- [ ] 密码登录
- [ ] 验证码登录
- [ ] 发布交易信息
- [ ] 查看交易详情（原方式）
- [ ] 管理员功能
- [ ] AI批量发布

## 七、测试报告模板

### 测试结果记录
```markdown
## 测试执行结果

### 测试环境
- URL: https://jr6ejz51qmcb.space.minimaxi.com
- 测试时间: YYYY-MM-DD HH:mm
- 测试人员: MiniMax Agent

### 测试结果汇总
| 测试路径 | 测试用例数 | 通过 | 失败 | 通过率 |
|---------|----------|------|------|--------|
| 积分返还机制 | 9 | X | Y | Z% |
| 新充值套餐 | 15 | X | Y | Z% |
| 快捷交易按钮 | 12 | X | Y | Z% |
| 下拉刷新 | 10 | X | Y | Z% |
| 查看历史 | 7 | X | Y | Z% |
| UI优化 | 6 | X | Y | Z% |
| **总计** | **59** | **X** | **Y** | **Z%** |

### 详细测试记录
[具体测试步骤和结果]

### 发现的问题
[列出所有问题]

### 建议
[改进建议]
```

## 八、部署检查清单

- [ ] toggle-post-status部署成功
- [ ] recharge-request部署成功
- [ ] 前端可访问
- [ ] Edge Functions可调用
- [ ] 数据库连接正常
- [ ] 环境变量配置正确
- [ ] CORS配置正确

## 九、上线前最终检查

- [ ] 所有测试用例通过
- [ ] 无阻断性Bug
- [ ] 性能指标达标
- [ ] 文档完整
- [ ] 备份旧版本数据
- [ ] 准备回滚方案

---

**状态**：等待Supabase token刷新
**下一步**：立即部署Edge Functions并执行完整测试
