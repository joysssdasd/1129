# 数据库权限错误修复报告

## 问题描述
**错误信息**: "new row violates row-level security policy"
**影响**: 管理员无法在后台上传微信/支付宝收款二维码
**原因**: payment_qrcodes表的RLS策略配置错误

## 修复过程

### 1. 问题诊断
- **数据库表**: `payment_qrcodes`
- **表结构**:
  - id (uuid, 主键)
  - payment_type (varchar, 支付类型)
  - qr_code_url (text, 二维码URL)
  - created_at (timestamp)
  - updated_at (timestamp)

### 2. RLS策略分析
**问题策略**:
```sql
-- 旧的有问题的策略
"Only admins can insert payment qrcodes"
WITH CHECK ("true")  -- 错误：没有验证管理员身份
```

**根本问题**: 
- INSERT策略的`with_check`设置为固定的`"true"`
- 没有验证当前用户是否为管理员
- 导致非管理员用户被阻止插入数据

### 3. 修复方案
删除问题策略并创建正确的策略：

```sql
-- 删除旧策略
DROP POLICY IF EXISTS "Only admins can insert payment qrcodes" ON payment_qrcodes;

-- 创建新策略
CREATE POLICY "Allow admins to insert payment qrcodes" ON payment_qrcodes
FOR INSERT TO authenticated
WITH CHECK (
    auth.uid() IS NOT NULL 
    AND auth.uid() IN (
        SELECT id FROM users WHERE is_admin = true OR role = 'admin'
    )
);
```

### 4. 策略详解
- **目标用户**: authenticated (已认证用户)
- **验证条件**: 
  - auth.uid()必须存在（已登录）
  - 用户ID必须在管理员列表中
- **管理员识别**: 
  - `is_admin = true` OR `role = 'admin'`
  - 符合数据库中管理员用户记录

### 5. 测试验证

#### 测试环境
- **项目**: mgyelmyjeidlvmmmjkqi.supabase.co
- **管理员用户**: 2个管理员账号
  - 13800138000 (id: 1df3216d-26b9-429e-9e0e-20b53b82e87a)
  - 13011319329 (id: 86fb9819-a685-4c1f-a63b-449c1a3acd30)

#### 测试结果
- ✅ 微信二维码插入测试通过
- ✅ 支付宝二维码插入测试通过
- ✅ 数据正确保存到数据库
- ✅ 清理测试数据完成

### 6. 最终RLS策略状态

| 操作 | 策略名称 | 权限 | 验证条件 |
|------|----------|------|----------|
| SELECT | Anyone can view payment qrcodes | 所有人可读 | 无限制 |
| INSERT | Allow admins to insert payment qrcodes | 管理员可插入 | 验证管理员身份 |
| UPDATE | Only admins can update payment qrcodes | 管理员可更新 | 验证管理员身份 |
| DELETE | Only admins can delete payment qrcodes | 管理员可删除 | 验证管理员身份 |

## 修复结果

### ✅ 问题解决
- **数据库权限错误已修复**
- **管理员现在可以正常上传收款二维码**
- **安全性保持**：只有真正的管理员可以修改支付信息

### ✅ 验证完成
- 微信收款码上传功能测试通过
- 支付宝收款码上传功能测试通过
- 数据保存和读取功能正常

### ✅ 部署信息
- **迁移名称**: `fix_payment_qrcodes_insert_policy`
- **执行时间**: 2025-11-11 21:17
- **影响范围**: payment_qrcodes表的INSERT操作
- **向后兼容**: 是，不影响现有功能

## 建议

1. **监控**: 建议在生产环境中监控支付相关操作
2. **权限审查**: 定期审查管理员用户列表
3. **测试覆盖**: 建立定期的权限策略测试流程

## 技术细节

- **Supabase项目**: mgyelmyjeidlvmmmjkqi.supabase.co
- **数据库表**: public.payment_qrcodes
- **关键字段**: users.is_admin, users.role
- **认证方式**: Supabase Auth + RLS策略

---
**修复完成时间**: 2025-11-11 21:17:46
**状态**: ✅ 已完成并验证