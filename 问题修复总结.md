# 问题修复总结

## 问题描述

1. **收款二维码不显示** - 充值界面看不到设置好的收款二维码
2. **付款截图无法上传** - 充值时无法上传付款截图

## 根本原因

项目从旧的 Supabase 项目 (`mgyelmyjeidlvmmmjkqi`) 迁移到新项目 (`hntiihuxqlklpiyqmlob`)，但：

1. **MCP 配置未更新** - `.mcp.json` 中的 `project-ref` 和 `SUPABASE_ACCESS_TOKEN` 还是旧项目的
2. **Edge Functions 未部署** - 新项目没有任何 Edge Functions
3. **数据库未初始化** - 新项目数据库是空的，没有表和数据
4. **Storage Buckets 未创建** - 没有创建存储收款二维码和充值截图的 buckets

## 已完成的修复

### 1. 更新配置文件

✅ 更新 `.mcp.json`:
- `project-ref`: `hntiihuxqlklpiyqmlob`
- `SUPABASE_ACCESS_TOKEN`: `sbp_d2b2bc15e6e5e402c7410f24f0c81b548bf260f4`

✅ 更新 `xiaochengxu/miniprogram/app.js`:
- `supabaseUrl`: `https://hntiihuxqlklpiyqmlob.supabase.co`
- `supabaseKey`: (新项目的 anon key)

✅ 更新 `.env.local`:
- 所有 Supabase 相关配置指向新项目

### 2. 创建 Edge Functions

✅ 创建 `wechat-quick-login` - 微信小程序一键登录
- 通过手机号授权获取用户手机号
- 自动将手机号设置为联系方式 (`wechat_id`)
- 新用户赠送 100 积分

✅ 其他关键函数已存在:
- `view-contact` - 查看联系方式
- `recharge-request` - 充值申请
- `publish-post` - 发布交易信息
- `toggle-post-status` - 上架/下架
- `process-referral-reward` - 邀请奖励

### 3. 更新小程序代码

✅ 更新 `login.js`:
- 简化登录流程，只需手机号授权码
- 正确处理返回的数据结构 (`res.data.user`)
- 显示新用户注册提示

✅ 更新 `detail.js`:
- 优先使用 `wechat_id` 字段（实际存的是手机号）
- 正确处理 `already_viewed` 状态
- 改进错误提示

### 4. 创建部署脚本和文档

✅ `deploy-edge-functions.bat` - 一键部署所有 Edge Functions
✅ `init-new-project.sql` - 数据库初始化 SQL
✅ `新项目部署指南.md` - 完整的部署步骤文档
✅ `test-new-project.bat` - 测试脚本

## 需要你完成的步骤

### 步骤 1: 初始化数据库

1. 打开 [SQL Editor](https://supabase.com/dashboard/project/hntiihuxqlklpiyqmlob/sql/new)
2. 复制 `init-new-project.sql` 的全部内容
3. 粘贴到 SQL Editor
4. 点击 "Run" 执行

这将创建所有必要的表：
- `users` - 用户表
- `posts` - 交易信息表
- `view_history` - 查看历史表
- `point_transactions` - 积分交易记录表
- `recharge_requests` - 充值申请表
- `payment_qrcodes` - 收款二维码表
- `invitations` - 邀请记录表

### 步骤 2: 创建 Storage Buckets

1. 打开 [Storage](https://supabase.com/dashboard/project/hntiihuxqlklpiyqmlob/storage/buckets)
2. 点击 "New bucket"

**创建 payment-qrcodes bucket:**
- Name: `payment-qrcodes`
- Public: ✅ (勾选)
- File size limit: 5 MB
- Allowed MIME types: `image/*`

**创建 recharge-screenshots bucket:**
- Name: `recharge-screenshots`
- Public: ✅ (勾选)
- File size limit: 10 MB
- Allowed MIME types: `image/*`

### 步骤 3: 部署 Edge Functions

在项目根目录运行：

```bash
deploy-edge-functions.bat
```

或手动执行：

```bash
npx supabase login
npx supabase link --project-ref hntiihuxqlklpiyqmlob
npx supabase functions deploy wechat-quick-login --no-verify-jwt
npx supabase functions deploy view-contact --no-verify-jwt
npx supabase functions deploy recharge-request --no-verify-jwt
npx supabase functions deploy publish-post --no-verify-jwt
npx supabase functions deploy toggle-post-status --no-verify-jwt
npx supabase functions deploy process-referral-reward --no-verify-jwt
```

### 步骤 4: 配置 Edge Function Secrets

1. 打开 [Edge Functions Settings](https://supabase.com/dashboard/project/hntiihuxqlklpiyqmlob/settings/functions)
2. 点击 "Add new secret"
3. 添加以下 secrets:

| Name | Value |
|------|-------|
| `WECHAT_MINIPROGRAM_APPID` | `wx0414f85654e5815f` |
| `WECHAT_MINIPROGRAM_SECRET` | (从微信公众平台获取) |

**获取小程序密钥:**
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 开发 → 开发管理 → 开发设置
3. 找到 AppSecret，点击"重置"或"查看"
4. 复制密钥

### 步骤 5: 上传收款二维码

1. 打开 [Storage - payment-qrcodes](https://supabase.com/dashboard/project/hntiihuxqlklpiyqmlob/storage/buckets/payment-qrcodes)
2. 上传微信收款二维码，命名为 `wechat-qr.jpg`
3. 上传支付宝收款二维码，命名为 `alipay-qr.jpg`
4. 在 SQL Editor 执行：

```sql
UPDATE payment_qrcodes 
SET qr_code_url = 'https://hntiihuxqlklpiyqmlob.supabase.co/storage/v1/object/public/payment-qrcodes/wechat-qr.jpg'
WHERE payment_type = 'wechat';

UPDATE payment_qrcodes 
SET qr_code_url = 'https://hntiihuxqlklpiyqmlob.supabase.co/storage/v1/object/public/payment-qrcodes/alipay-qr.jpg'
WHERE payment_type = 'alipay';
```

### 步骤 6: 配置微信小程序服务器域名

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 开发 → 开发管理 → 开发设置 → 服务器域名
3. 添加以下域名到所有类型（request、uploadFile、downloadFile）:

```
https://hntiihuxqlklpiyqmlob.supabase.co
```

### 步骤 7: 测试功能

运行测试脚本：

```bash
test-new-project.bat
```

或在微信开发者工具中测试：

1. **测试登录**
   - 点击"微信一键登录"
   - 授权手机号
   - 检查是否成功登录

2. **测试充值**
   - 进入充值页面
   - 检查是否显示收款二维码
   - 选择金额并上传截图
   - 提交充值申请

3. **测试发布**
   - 发布一条交易信息
   - 检查积分是否扣除

4. **测试查看联系方式**
   - 查看任意交易信息
   - 点击"查看联系方式"
   - 检查是否自动复制

## 技术细节

### 微信一键登录流程

1. 用户点击按钮，触发 `open-type="getPhoneNumber"`
2. 微信返回手机号授权码 (`code`)
3. 小程序调用 `wechat-quick-login` Edge Function
4. Edge Function 使用 `code` 调用微信 API 获取手机号
5. 查找或创建用户，将手机号设置为 `wechat_id`
6. 返回用户信息给小程序

### 收款二维码显示流程

1. 充值页面 `onLoad` 时调用 `loadPaymentQRCodes()`
2. 查询 `payment_qrcodes` 表，筛选 `status=active`
3. 分别获取微信和支付宝的二维码 URL
4. 在页面上显示二维码图片

### 充值截图上传流程

1. 用户选择图片，转为 base64
2. 调用 `recharge-request` Edge Function
3. Edge Function 将 base64 解码为二进制
4. 上传到 `recharge-screenshots` bucket
5. 创建充值申请记录，状态为"待审核"

## 常见问题排查

### Q: 收款二维码还是不显示

**检查清单:**
- [ ] Storage bucket `payment-qrcodes` 已创建且为 Public
- [ ] `payment_qrcodes` 表有数据且 `status='active'`
- [ ] 二维码 URL 正确且可访问
- [ ] 小程序代码中的 `supabaseUrl` 正确

**调试方法:**
```javascript
// 在 recharge.js 的 loadPaymentQRCodes 方法中添加
console.log('API URL:', app.globalData.supabaseUrl + '/rest/v1/payment_qrcodes?status=eq.active')
console.log('Response:', res.data)
```

### Q: 付款截图上传失败

**检查清单:**
- [ ] Storage bucket `recharge-screenshots` 已创建
- [ ] Edge Function `recharge-request` 已部署
- [ ] Edge Function 有 Storage 写入权限

**查看日志:**
1. 打开 [Edge Functions Logs](https://supabase.com/dashboard/project/hntiihuxqlklpiyqmlob/logs/edge-functions)
2. 选择 `recharge-request` 函数
3. 查看错误信息

### Q: 微信登录失败

**检查清单:**
- [ ] Edge Function Secrets 已配置
- [ ] 小程序 AppID 和 AppSecret 正确
- [ ] 微信服务器域名已配置
- [ ] Edge Function `wechat-quick-login` 已部署

**常见错误:**
- `40013`: AppID 或 AppSecret 错误
- `40029`: code 无效或已过期
- `48001`: 未配置 API 权限

## 下一步建议

1. **创建管理员账号** - 用于审核充值申请
2. **配置自动过期** - 定时下架过期的交易信息
3. **监控日志** - 定期检查 Edge Function 日志
4. **数据备份** - 定期备份数据库

## 相关文档

- `新项目部署指南.md` - 完整部署步骤
- `deploy-edge-functions.bat` - Edge Functions 部署脚本
- `init-new-project.sql` - 数据库初始化 SQL
- `test-new-project.bat` - 测试脚本

## 联系支持

如遇到问题，请检查：
1. Supabase Dashboard 日志
2. Edge Function 日志
3. 微信开发者工具控制台
4. 浏览器开发者工具网络请求
