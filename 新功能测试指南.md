# 新功能测试指南

## 部署信息
- **生产URL**: https://vs25wq4sf64a.space.minimaxi.com
- **部署时间**: 2025-11-10
- **版本**: v2.0 - 二维码管理 + AI批量发布优化

## 新功能概览

### 功能1: 充值审核二维码管理
管理员可以上传和管理微信/支付宝收款二维码，用户在充值时可以看到这些二维码。

### 功能2: AI批量发布优化
优化了AI批量发布功能，采用多步骤工作流：选择发布类型 → AI解析 → 人工审核 → 批量发布。

## 测试账号

### 管理员账号
- **手机号**: 13011319329 或 13800138000
- **登录方式**: 仅支持验证码登录
- **验证码获取**: 点击"发送验证码"后，从数据库查询（见下方SQL）

### 普通用户账号
- **手机号**: 13500000001
- **密码**: abc1234
- **积分**: 100

## 测试步骤

### 一、测试管理员二维码管理功能

#### 步骤 1: 管理员登录
1. 访问 https://vs25wq4sf64a.space.minimaxi.com
2. 点击"登录/注册"
3. 输入管理员手机号: `13011319329`
4. 点击"发送验证码"
5. **获取验证码**:
   ```sql
   SELECT code, expires_at 
   FROM verification_codes 
   WHERE phone = '13011319329' 
   ORDER BY created_at DESC 
   LIMIT 1;
   ```
6. 输入验证码并登录
7. 应自动跳转到管理后台 `/admin`

#### 步骤 2: 上传收款二维码
1. 在管理后台，找到"充值审核"标签页
2. 向下滚动，找到"收款二维码管理"区域
3. **上传微信收款码**:
   - 点击"选择图片"或拖拽图片到上传区域
   - 支持 JPG、PNG、GIF 格式
   - 图片大小限制：5MB以内
   - 预览图片，确认无误
   - 点击"保存微信收款码"
4. **上传支付宝收款码**:
   - 同样的流程上传支付宝收款二维码
   - 点击"保存支付宝收款码"
5. **验证**:
   - 上传成功后，应显示二维码预览
   - 可以点击"编辑"按钮更换二维码
   - 可以点击"删除"按钮移除二维码

#### 步骤 3: 测试用户端显示
1. 退出管理员账号
2. 使用普通用户账号登录 (13500000001 / abc1234)
3. 进入个人中心
4. 点击"充值"选项
5. **验证二维码显示**:
   - 应该看到"请扫码支付"区域
   - 微信支付和支付宝支付的二维码并排显示
   - 每个二维码都有对应的图标和说明文字
   - 二维码图片清晰可见
6. **测试充值流程**:
   - 选择充值档位
   - 查看二维码（实际支付可跳过）
   - 上传付款截图
   - 提交充值申请

### 二、测试AI批量发布优化功能

#### 步骤 1: 进入AI批量发布
1. 使用管理员账号登录
2. 在管理后台，找到"AI批量发布"标签页
3. 应该看到全新的多步骤界面

#### 步骤 2: 配置发布参数（第一步）
1. **选择发布类型**:
   - 点击"买入"或"卖出"按钮
   - 应该有明显的选中状态
2. **输入微信ID绑定**:
   - 输入微信号（例如: test_wechat_01）
   - 此微信号将用于所有批量发布的信息
3. 点击"下一步：AI解析"

#### 步骤 3: AI解析（第二步）
1. **准备待发布内容**:
   ```
   出一个iPhone 15 Pro，256G，95新，无磕碰，电池健康90%，价格6500
   卖一个MacBook Air M2，8+256，99新，几乎全新，带包装盒，8000
   转让iPad Pro 11寸，128G，一年内购买，9成新，3500
   ```
2. **粘贴内容并解析**:
   - 将上述内容粘贴到文本框
   - 点击"开始AI解析"
   - 等待解析完成（约5-10秒）
3. **验证解析结果**:
   - 应显示解析出的信息列表
   - 每条信息包括：标题、描述、价格等
   - AI自动识别商品类型和关键信息

#### 步骤 4: 人工审核（第三步）
1. **审核每条信息**:
   - 查看AI生成的标题是否准确
   - 查看描述是否完整
   - 检查价格是否正确
2. **编辑信息**（如需要）:
   - 点击"编辑"按钮修改标题或描述
   - 调整价格
   - 删除不需要的信息
3. 确认无误后，点击"确认并批量发布"

#### 步骤 5: 发布完成验证
1. 发布成功后应看到成功提示
2. 点击"返回信息管理"或刷新页面
3. **验证发布结果**:
   - 在"信息管理"标签页查看新发布的信息
   - 确认微信ID绑定正确
   - 确认发布类型（买入/卖出）正确
   - 确认所有字段准确无误

### 三、完整性测试

#### 测试点 1: 边界情况
- 上传超大图片（>5MB）应提示错误
- 上传非图片文件应提示错误
- 发送验证码后60秒内不能重复发送
- AI解析空内容应提示错误

#### 测试点 2: 用户体验
- 页面加载速度正常
- 按钮hover效果正常
- 表单验证提示清晰
- 成功/错误提示明显

#### 测试点 3: 响应式设计
- 在手机浏览器测试（或使用开发者工具模拟）
- 二维码显示应适配小屏幕
- AI批量发布界面应可滚动
- 所有按钮可点击，不被遮挡

## 常见问题排查

### 问题 1: 验证码登录失败
- **原因**: 验证码过期（5分钟有效期）
- **解决**: 重新发送验证码并快速登录

### 问题 2: 二维码上传后不显示
- **原因**: 图片格式不支持或文件损坏
- **解决**: 使用JPG或PNG格式，确保文件完整

### 问题 3: AI解析失败
- **原因**: DeepSeek API调用失败或内容格式问题
- **解决**: 检查网络连接，确保内容格式规范

### 问题 4: 批量发布部分失败
- **原因**: 积分不足或数据库错误
- **解决**: 检查管理员账号积分，查看错误日志

## Edge Function测试结果

### 后端验证（已通过）
✅ `get-payment-qrcodes`: 获取收款二维码 - 200 OK
✅ `save-payment-qrcode`: 保存收款二维码 - 200 OK  
✅ `auth-login`: 管理员登录 - 200 OK
✅ `ai-batch-publish-v2`: AI批量发布 - 需要完整测试

### 数据库验证（已通过）
✅ `payment_qrcodes` 表创建成功
✅ 数据插入和查询正常
✅ 存储桶权限配置正确

## 技术细节

### 新增Edge Functions
1. **save-payment-qrcode** (保存收款二维码)
   - URL: `/functions/v1/save-payment-qrcode`
   - 方法: POST
   - 参数: `payment_type`, `image_file`

2. **get-payment-qrcodes** (获取收款二维码)
   - URL: `/functions/v1/get-payment-qrcodes`
   - 方法: POST
   - 返回: `wechat`, `alipay` 二维码URL

3. **ai-batch-publish-v2** (AI批量发布v2)
   - URL: `/functions/v1/ai-batch-publish-v2`
   - 方法: POST
   - 参数: `trade_type`, `wechat_id`, `raw_content`

### 新增组件
1. **QRCodeManager.tsx** (二维码管理组件)
   - 位置: `/src/components/QRCodeManager.tsx`
   - 功能: 上传、预览、编辑、删除二维码

2. **AIBatchPublish.tsx** (AI批量发布组件)
   - 位置: `/src/components/AIBatchPublish.tsx`
   - 功能: 多步骤工作流，AI解析，人工审核

### 数据库表
```sql
-- payment_qrcodes 表结构
CREATE TABLE payment_qrcodes (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    payment_type TEXT NOT NULL, -- 'wechat' 或 'alipay'
    qr_code_url TEXT NOT NULL,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

## 下一步

测试完成后，请反馈：
1. ✅ 所有功能正常
2. ⚠️ 发现的问题（描述具体现象）
3. 💡 改进建议

---
**测试完成时间**: _______
**测试人员**: _______
**测试结果**: ⬜ 通过  ⬜ 部分通过  ⬜ 失败
