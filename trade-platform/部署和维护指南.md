# 牛牛基地 - 部署和维护指南

## 部署信息

### 生产环境
- **访问URL**: https://da8q1o1p7yye.space.minimaxi.com
- **部署状态**: 已成功部署上线
- **部署时间**: 2025-11-10
- **SSL证书**: 自动配置（HTTPS）

### Supabase配置
- **项目ID**: mgyelmyjeidlvmmmjkqi
- **项目URL**: https://mgyelmyjeidlvmmmjkqi.supabase.co
- **区域**: ap-southeast-1 (新加坡)
- **数据库**: PostgreSQL
- **存储**: Supabase Storage

## 系统架构

### 前端部署
- **技术栈**: React + TypeScript + TailwindCSS
- **构建工具**: Vite
- **部署方式**: 静态文件部署
- **CDN**: CloudFlare
- **资源**: /workspace/trade-platform/dist

### 后端服务

#### 数据库（9张表）
1. **users** - 用户表
   - 存储用户基本信息、积分、成交率
   - 索引: phone, invite_code, status
   
2. **posts** - 交易信息表
   - 存储交易信息内容
   - 索引: user_id, status, created_at, trade_type

3. **point_transactions** - 积分流水表
   - 记录所有积分变动
   - 索引: user_id, created_at, change_type

4. **recharge_requests** - 充值申请表
   - 存储充值申请和审核记录
   - 索引: user_id, status, created_at

5. **admin_settings** - 管理员设置表
   - 系统配置和收款二维码
   - 索引: key

6. **view_history** - 查看历史表
   - 记录用户查看联系方式的历史
   - 索引: user_id, post_id, viewed_at

7. **invitations** - 邀请记录表
   - 跟踪邀请关系和奖励发放
   - 索引: inviter_code, invitee_id

8. **verification_codes** - 验证码表
   - 存储短信验证码
   - 索引: phone, expires_at

9. **announcements** - 系统公告表
   - 平台公告信息
   - 索引: is_active, priority

#### Edge Functions（9个）
1. **send-verification-code** - 发送验证码
   - 集成spug短信API
   - 防刷机制：1小时最多3次
   
2. **auth-register** - 用户注册
   - 验证码校验
   - 自动发放注册奖励100积分
   - 处理邀请关系

3. **auth-login** - 用户登录
   - 验证码登录
   - 账号状态检查

4. **publish-post** - 发布交易信息
   - 扣除10积分
   - 邀请奖励发放逻辑
   - 自动设置72小时过期

5. **view-contact** - 查看联系方式
   - 扣除1积分
   - 记录查看历史
   - 防重复扣费

6. **recharge-request** - 充值申请
   - 上传付款截图
   - 创建待审核申请

7. **admin-approve-recharge** - 管理员审核充值
   - 验证管理员权限
   - 积分到账
   - 记录审核操作

8. **ai-batch-publish** - AI批量发布
   - DeepSeek API集成
   - 文本智能解析
   - 批量创建交易信息

9. **auto-expire-posts** - 自动下架（定时任务）
   - 每小时执行一次
   - 下架过期信息
   - 退还剩余积分

#### 存储桶（2个）
1. **payment-qrcodes** - 收款二维码
   - 公开访问
   - 5MB文件大小限制

2. **recharge-screenshots** - 充值截图
   - 公开访问
   - 5MB文件大小限制

#### 定时任务
- **auto-expire-posts_invoke**
  - Cron表达式: `0 * * * *` (每小时执行)
  - 功能: 自动下架过期信息
  - 状态: 已激活

## 外部服务集成

### 短信服务（spug平台）
- **服务商**: spug.cc
- **发送URL**: https://push.spug.cc/send/Xyd9M8AlV5rKbDBk
- **用户ID**: 5a73b0f94f134f03a9175c186a0f5fec
- **应用Key**: ak_oYWyP1Dwvzk9qMjwxerBRgQp6E4NeAnb
- **文档**: https://push.spug.cc/guide/sms-code

### AI服务（DeepSeek）
- **API Key**: sk-4dac2f720dfc43a18dc3f46053a68f16
- **模型**: deepseek-chat
- **用途**: 批量发布文本解析
- **API地址**: https://api.deepseek.com/v1/chat/completions

## 日常维护

### 监控检查项

#### 每日检查
1. **系统可用性**
   - 访问生产URL确认网站正常
   - 检查登录注册功能
   - 测试发布和查看功能

2. **充值审核**
   - 登录管理后台
   - 处理待审核的充值申请
   - 查看充值截图并确认

3. **信息管理**
   - 检查是否有违规信息
   - 处理用户举报
   - 清理垃圾信息

#### 每周检查
1. **数据统计**
   - 查看用户增长数据
   - 查看交易信息发布量
   - 查看积分流转情况

2. **系统性能**
   - 检查页面加载速度
   - 检查API响应时间
   - 查看Edge Function执行日志

#### 每月检查
1. **数据备份验证**
   - 确认Supabase自动备份正常
   - 导出关键数据备份

2. **安全检查**
   - 检查异常登录
   - 检查批量操作
   - 更新安全配置

### 常见运维任务

#### 1. 添加管理员
```sql
-- 将现有用户设置为管理员
UPDATE users 
SET is_admin = true 
WHERE phone = '手机号';
```

#### 2. 手动增减用户积分
```sql
-- 增加积分
UPDATE users 
SET points = points + 100 
WHERE phone = '手机号';

-- 记录积分变动
INSERT INTO point_transactions 
(user_id, change_type, change_amount, balance_after, description) 
VALUES 
('用户ID', 4, 100, '新积分余额', '手动调整');
```

#### 3. 禁用/启用用户
```sql
-- 禁用用户
UPDATE users 
SET status = 0 
WHERE phone = '手机号';

-- 启用用户
UPDATE users 
SET status = 1 
WHERE phone = '手机号';
```

#### 4. 手动下架信息
```sql
-- 下架特定信息
UPDATE posts 
SET status = 0 
WHERE id = '信息ID';
```

#### 5. 查看系统统计
```sql
-- 用户总数
SELECT COUNT(*) FROM users;

-- 今日新增用户
SELECT COUNT(*) FROM users 
WHERE created_at >= CURRENT_DATE;

-- 上架中的信息
SELECT COUNT(*) FROM posts WHERE status = 1;

-- 待审核的充值申请
SELECT COUNT(*) FROM recharge_requests WHERE status = 0;
```

#### 6. 更新热门关键词
```sql
UPDATE admin_settings 
SET value = '演唱会,门票,邀请函,代录,转让,球赛,展览' 
WHERE key = 'hot_keywords';
```

## 故障排查

### 问题：用户无法注册
**可能原因**:
1. 短信服务异常
2. 数据库RLS策略问题
3. Edge Function错误

**排查步骤**:
1. 检查Edge Function日志
2. 测试短信API
3. 验证RLS策略配置

### 问题：积分没有到账
**可能原因**:
1. 交易未正确记录
2. Edge Function执行失败

**排查步骤**:
1. 查询point_transactions表
2. 检查Edge Function日志
3. 手动补发积分

### 问题：自动下架未执行
**可能原因**:
1. Cron任务失效
2. Edge Function超时

**排查步骤**:
1. 检查Cron任务状态
2. 查看Edge Function日志
3. 手动触发下架函数

### 问题：充值审核失败
**可能原因**:
1. 权限验证失败
2. 数据库操作异常

**排查步骤**:
1. 确认管理员is_admin标志
2. 检查Edge Function日志
3. 验证RLS策略

## 性能优化建议

### 数据库优化
1. **定期清理过期验证码**
   ```sql
   DELETE FROM verification_codes 
   WHERE expires_at < NOW() - INTERVAL '7 days';
   ```

2. **监控慢查询**
   - 查看Supabase Dashboard
   - 优化高频查询
   - 添加必要索引

### 前端优化
1. 图片压缩和优化
2. 代码分割和懒加载
3. CDN缓存配置

### Edge Function优化
1. 减少数据库查询次数
2. 优化API调用
3. 合理使用缓存

## 扩展建议

### 功能扩展
1. **微信小程序版本**
   - 更好的移动体验
   - 推送通知
   - 一键分享

2. **成交确认自动化**
   - 24小时后自动推送
   - 提高成交率准确性

3. **信用评分系统**
   - 基于成交率和活跃度
   - 优质用户标识

4. **数据分析面板**
   - 实时数据可视化
   - 用户行为分析
   - 运营决策支持

### 技术升级
1. **缓存层**
   - Redis缓存热点数据
   - 提升查询性能

2. **消息队列**
   - 异步处理耗时任务
   - 提高系统响应速度

3. **搜索优化**
   - 全文搜索引擎
   - 智能推荐算法

## 安全建议

### 数据安全
1. 敏感数据加密存储
2. 定期备份验证
3. 访问日志审计

### 应用安全
1. API限流保护
2. SQL注入防护
3. XSS防护

### 运营安全
1. 异常行为监控
2. 防刷机制
3. 黑名单管理

## 技术支持

### Supabase相关
- **Dashboard**: https://supabase.com/dashboard/project/mgyelmyjeidlvmmmjkqi
- **文档**: https://supabase.com/docs
- **社区**: https://github.com/supabase/supabase

### 代码仓库
- **位置**: /workspace/trade-platform
- **构建命令**: `pnpm run build`
- **开发命令**: `pnpm run dev`

## 更新日志

### V1.0 (2025-11-10)
- 初始版本发布
- 完整的用户系统
- 交易信息发布和查看
- 积分系统
- 充值审核
- 管理后台
- AI批量发布
- 自动下架定时任务

## 联系方式

如有技术问题或需要支持，请联系系统管理员。
