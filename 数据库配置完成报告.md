# æ•°æ®åº“é…ç½®å®ŒæˆæŠ¥å‘Š

## æ‰§è¡Œæ—¶é—´
2025-12-22

## é¡¹ç›®ä¿¡æ¯
- **é¡¹ç›® ID**: `hntiihuxqlklpiyqmlob`
- **é¡¹ç›®åç§°**: ticketæœ¬åœ°
- **åŒºåŸŸ**: ap-southeast-1 (æ–°åŠ å¡)
- **çŠ¶æ€**: ACTIVE_HEALTHY
- **æ•°æ®åº“ç‰ˆæœ¬**: PostgreSQL 17.6.1
- **API URL**: https://hntiihuxqlklpiyqmlob.supabase.co

---

## âœ… å·²å®Œæˆçš„é…ç½®

### 1. æ•°æ®åº“è¡¨ç»“æ„

æ‰€æœ‰å¿…è¦çš„è¡¨å·²å­˜åœ¨å¹¶é…ç½®å®Œæˆï¼š

| è¡¨å | è¡Œæ•° | RLS å¯ç”¨ | è¯´æ˜ |
|------|------|----------|------|
| `users` | 0 | âœ… | ç”¨æˆ·è¡¨ |
| `posts` | 1 | âœ… | äº¤æ˜“ä¿¡æ¯è¡¨ |
| `view_history` | 1 | âœ… | æŸ¥çœ‹å†å²è¡¨ |
| `point_transactions` | 2 | âœ… | ç§¯åˆ†äº¤æ˜“è®°å½•è¡¨ |
| `recharge_requests` | 0 | âœ… | å……å€¼ç”³è¯·è¡¨ |
| `payment_qrcodes` | 2 | âœ… | æ”¶æ¬¾äºŒç»´ç è¡¨ â­ |
| `invitations` | 0 | âœ… | é‚€è¯·è®°å½•è¡¨ |
| `verification_codes` | 1 | âœ… | éªŒè¯ç è¡¨ |
| `announcements` | 1 | âœ… | å…¬å‘Šè¡¨ |
| `banned_keywords` | 29 | âœ… | è¿ç¦è¯è¡¨ |
| `reports` | 0 | âœ… | ä¸¾æŠ¥è¡¨ |
| `system_settings` | 2 | âœ… | ç³»ç»Ÿè®¾ç½®è¡¨ |

### 2. æ•°æ®åº“è¿ç§»

å·²åº”ç”¨çš„è¿ç§»ï¼š

#### Migration 1: `add_ip_fields_to_users`
```sql
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS register_ip VARCHAR(50),
ADD COLUMN IF NOT EXISTS last_login_ip VARCHAR(50),
ADD COLUMN IF NOT EXISTS last_login_at TIMESTAMP WITH TIME ZONE;
```
**çŠ¶æ€**: âœ… æˆåŠŸ

#### Migration 2: `add_delivery_days_to_posts`
```sql
ALTER TABLE posts 
ADD COLUMN IF NOT EXISTS delivery_days INTEGER;
```
**çŠ¶æ€**: âœ… æˆåŠŸ

#### Migration 3: `create_storage_buckets`
```sql
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types) 
VALUES 
  ('payment-qrcodes', 'payment-qrcodes', true, 5242880, ARRAY['image/*']),
  ('recharge-screenshots', 'recharge-screenshots', true, 10485760, ARRAY['image/*'])
ON CONFLICT (id) DO NOTHING;
```
**çŠ¶æ€**: âœ… æˆåŠŸ

### 3. æ”¶æ¬¾äºŒç»´ç æ•°æ® â­

å·²æˆåŠŸæ’å…¥æ”¶æ¬¾äºŒç»´ç è®°å½•ï¼š

| ID | æ”¯ä»˜ç±»å‹ | URL | çŠ¶æ€ |
|----|---------|-----|------|
| `9c03db3b-e723-48be-8c5d-45de42059e0a` | wechat | https://hntiihuxqlklpiyqmlob.supabase.co/storage/v1/object/public/payment-qrcodes/wechat-qr.jpg | active |
| `7852e3a5-fe71-44d7-b6f3-806374a45a57` | alipay | https://hntiihuxqlklpiyqmlob.supabase.co/storage/v1/object/public/payment-qrcodes/alipay-qr.jpg | active |

**æ³¨æ„**: è¿™äº› URL æŒ‡å‘çš„äºŒç»´ç å›¾ç‰‡éœ€è¦ä½ æ‰‹åŠ¨ä¸Šä¼ åˆ° Storageã€‚

### 4. Storage Buckets

å·²åˆ›å»ºçš„ Storage Bucketsï¼š

| Bucket ID | åç§° | å…¬å¼€ | å¤§å°é™åˆ¶ | ç”¨é€” |
|-----------|------|------|----------|------|
| `payment-qrcodes` | payment-qrcodes | âœ… Public | 5 MB | å­˜å‚¨æ”¶æ¬¾äºŒç»´ç  |
| `recharge-screenshots` | recharge-screenshots | âœ… Public | 10 MB | å­˜å‚¨å……å€¼æˆªå›¾ |
| `qrcodes` | qrcodes | âœ… Public | - | æ—§çš„äºŒç»´ç å­˜å‚¨ |
| `payment-screenshots` | payment-screenshots | âœ… Public | - | æ—§çš„æˆªå›¾å­˜å‚¨ |
| `announcements` | announcements | âœ… Public | - | å…¬å‘Šé™„ä»¶ |
| `post-media` | post-media | âŒ Private | - | å¸–å­åª’ä½“ |

### 5. Edge Functions

å·²éƒ¨ç½²çš„ Edge Functionsï¼ˆå…± 28 ä¸ªï¼‰ï¼š

#### æ ¸å¿ƒåŠŸèƒ½
- âœ… `wechat-quick-login` (v3) - å¾®ä¿¡å°ç¨‹åºä¸€é”®ç™»å½•
- âœ… `view-contact` (v4) - æŸ¥çœ‹è”ç³»æ–¹å¼
- âœ… `recharge-request` (v3) - å……å€¼ç”³è¯·
- âœ… `publish-post` (v3) - å‘å¸ƒäº¤æ˜“ä¿¡æ¯
- âœ… `toggle-post-status` (v3) - ä¸Šæ¶/ä¸‹æ¶
- âœ… `process-referral-reward` (v3) - é‚€è¯·å¥–åŠ±

#### è®¤è¯ç›¸å…³
- âœ… `auth-login` (v4)
- âœ… `auth-register` (v3)
- âœ… `send-verification-code` (v4)
- âœ… `verify-sms` (v4)
- âœ… `register-with-password` (v4)
- âœ… `login-with-password` (v4)
- âœ… `change-password` (v3)
- âœ… `reset-password` (v3)
- âœ… `wechat-login` (v3)
- âœ… `wechat-miniprogram-login` (v2)
- âœ… `wechat-bindphone` (v2)
- âœ… `wechat-check-login` (v2)

#### ç®¡ç†åŠŸèƒ½
- âœ… `admin-approve-recharge` (v3)
- âœ… `get-payment-qrcodes` (v3)
- âœ… `save-payment-qrcode` (v3)
- âœ… `create-admin-user` (v3)

#### å…¶ä»–åŠŸèƒ½
- âœ… `get-invitation-info` (v3)
- âœ… `ai-batch-publish` (v3)
- âœ… `ai-batch-publish-v2` (v3)
- âœ… `auto-expire-posts` (v3)
- âœ… `get-keyword-analytics` (v3)
- âœ… `manual-expire-fix` (v3)

---

## ğŸ”§ éœ€è¦ä½ å®Œæˆçš„æ­¥éª¤

### æ­¥éª¤ 1: ä¸Šä¼ æ”¶æ¬¾äºŒç»´ç  â­ é‡è¦

1. æ‰“å¼€ [Storage - payment-qrcodes](https://supabase.com/dashboard/project/hntiihuxqlklpiyqmlob/storage/buckets/payment-qrcodes)
2. ä¸Šä¼ ä½ çš„å¾®ä¿¡æ”¶æ¬¾äºŒç»´ç ï¼Œå‘½åä¸º `wechat-qr.jpg`
3. ä¸Šä¼ ä½ çš„æ”¯ä»˜å®æ”¶æ¬¾äºŒç»´ç ï¼Œå‘½åä¸º `alipay-qr.jpg`

**ä¸Šä¼ åï¼Œå……å€¼é¡µé¢å°±èƒ½æ˜¾ç¤ºæ”¶æ¬¾äºŒç»´ç äº†ï¼**

### æ­¥éª¤ 2: é…ç½® Edge Function Secrets

1. æ‰“å¼€ [Edge Functions Settings](https://supabase.com/dashboard/project/hntiihuxqlklpiyqmlob/settings/functions)
2. æ·»åŠ ä»¥ä¸‹ Secrets:

| Secret Name | Value | è¯´æ˜ |
|------------|-------|------|
| `WECHAT_MINIPROGRAM_APPID` | `wx0414f85654e5815f` | å°ç¨‹åº AppID |
| `WECHAT_MINIPROGRAM_SECRET` | (ä»å¾®ä¿¡å…¬ä¼—å¹³å°è·å–) | å°ç¨‹åºå¯†é’¥ |

**è·å–å°ç¨‹åºå¯†é’¥:**
1. ç™»å½• [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
2. å¼€å‘ â†’ å¼€å‘ç®¡ç† â†’ å¼€å‘è®¾ç½®
3. æ‰¾åˆ° AppSecretï¼Œç‚¹å‡»"é‡ç½®"æˆ–"æŸ¥çœ‹"
4. å¤åˆ¶å¯†é’¥

### æ­¥éª¤ 3: é…ç½®å¾®ä¿¡å°ç¨‹åºæœåŠ¡å™¨åŸŸå

1. ç™»å½• [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
2. å¼€å‘ â†’ å¼€å‘ç®¡ç† â†’ å¼€å‘è®¾ç½® â†’ æœåŠ¡å™¨åŸŸå
3. æ·»åŠ ä»¥ä¸‹åŸŸååˆ°æ‰€æœ‰ç±»å‹ï¼ˆrequestã€uploadFileã€downloadFileï¼‰:

```
https://hntiihuxqlklpiyqmlob.supabase.co
```

### æ­¥éª¤ 4: æµ‹è¯•åŠŸèƒ½

åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æµ‹è¯•ï¼š

#### æµ‹è¯•ç™»å½•
- [ ] ç‚¹å‡»"å¾®ä¿¡ä¸€é”®ç™»å½•"
- [ ] æˆæƒæ‰‹æœºå·
- [ ] æˆåŠŸç™»å½•å¹¶æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯

#### æµ‹è¯•å……å€¼ â­
- [ ] è¿›å…¥å……å€¼é¡µé¢
- [ ] æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºæ”¶æ¬¾äºŒç»´ç 
- [ ] é€‰æ‹©é‡‘é¢å¹¶ä¸Šä¼ æˆªå›¾
- [ ] æäº¤å……å€¼ç”³è¯·

#### æµ‹è¯•å‘å¸ƒ
- [ ] å‘å¸ƒä¸€æ¡äº¤æ˜“ä¿¡æ¯
- [ ] æ£€æŸ¥ç§¯åˆ†æ˜¯å¦æ‰£é™¤

#### æµ‹è¯•æŸ¥çœ‹è”ç³»æ–¹å¼
- [ ] æŸ¥çœ‹ä»»æ„äº¤æ˜“ä¿¡æ¯
- [ ] ç‚¹å‡»"æŸ¥çœ‹è”ç³»æ–¹å¼"
- [ ] æ£€æŸ¥æ˜¯å¦è‡ªåŠ¨å¤åˆ¶

---

## ğŸ“Š æ•°æ®åº“ç»Ÿè®¡

- **æ€»è¡¨æ•°**: 12 ä¸ª
- **RLS å¯ç”¨**: 12/12 (100%)
- **æ€»è¡Œæ•°**: 36 è¡Œ
- **Edge Functions**: 28 ä¸ª
- **Storage Buckets**: 6 ä¸ª

---

## ğŸ”’ å®‰å…¨çŠ¶æ€

### å®‰å…¨å»ºè®®

æ£€æµ‹åˆ° 7 ä¸ªè­¦å‘Šï¼ˆéå…³é”®ï¼‰ï¼š

1. **Function Search Path Mutable** (6 ä¸ªå‡½æ•°)
   - å½±å“: ä½
   - è¯´æ˜: éƒ¨åˆ†æ•°æ®åº“å‡½æ•°çš„ search_path æœªå›ºå®š
   - å»ºè®®: å¯ä»¥å¿½ç•¥ï¼Œä¸å½±å“åŠŸèƒ½

2. **Leaked Password Protection Disabled**
   - å½±å“: ä¸­
   - è¯´æ˜: æœªå¯ç”¨å¯†ç æ³„éœ²ä¿æŠ¤
   - å»ºè®®: åœ¨ Auth Settings ä¸­å¯ç”¨

### RLS ç­–ç•¥

æ‰€æœ‰è¡¨éƒ½å·²å¯ç”¨ RLSï¼Œé€šè¿‡ Edge Functions æ§åˆ¶æƒé™ã€‚

---

## ğŸ¯ é—®é¢˜è§£å†³çŠ¶æ€

### é—®é¢˜ 1: æ”¶æ¬¾äºŒç»´ç ä¸æ˜¾ç¤º âœ… å·²è§£å†³

**åŸå› **: `payment_qrcodes` è¡¨ä¸ºç©º

**è§£å†³æ–¹æ¡ˆ**:
- âœ… æ’å…¥äº†å¾®ä¿¡å’Œæ”¯ä»˜å®çš„æ”¶æ¬¾äºŒç»´ç è®°å½•
- âœ… åˆ›å»ºäº† `payment-qrcodes` Storage Bucket
- â³ éœ€è¦ä½ ä¸Šä¼ å®é™…çš„äºŒç»´ç å›¾ç‰‡

### é—®é¢˜ 2: ä»˜æ¬¾æˆªå›¾æ— æ³•ä¸Šä¼  âœ… å·²è§£å†³

**åŸå› **: ç¼ºå°‘ `recharge-screenshots` Storage Bucket

**è§£å†³æ–¹æ¡ˆ**:
- âœ… åˆ›å»ºäº† `recharge-screenshots` Storage Bucket (Public, 10MB é™åˆ¶)
- âœ… Edge Function `recharge-request` å·²éƒ¨ç½²

---

## ğŸ“ ä¸‹ä¸€æ­¥å»ºè®®

1. **ç«‹å³**: ä¸Šä¼ æ”¶æ¬¾äºŒç»´ç åˆ° Storage
2. **ç«‹å³**: é…ç½®å¾®ä¿¡å°ç¨‹åº Secrets
3. **ç«‹å³**: é…ç½®å¾®ä¿¡æœåŠ¡å™¨åŸŸå
4. **æµ‹è¯•**: å®Œæ•´æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
5. **ç›‘æ§**: æŸ¥çœ‹ Edge Functions æ—¥å¿—
6. **ä¼˜åŒ–**: æ ¹æ®éœ€è¦è°ƒæ•´ RLS ç­–ç•¥

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `æ–°é¡¹ç›®éƒ¨ç½²æŒ‡å—.md` - å®Œæ•´éƒ¨ç½²æ­¥éª¤
- `é—®é¢˜ä¿®å¤æ€»ç»“.md` - é—®é¢˜åˆ†æå’Œè§£å†³æ–¹æ¡ˆ
- `éƒ¨ç½²æ£€æŸ¥æ¸…å•.md` - è¯¦ç»†æ£€æŸ¥æ¸…å•

---

## âœ… æ€»ç»“

æ•°æ®åº“é…ç½®å·²å…¨éƒ¨å®Œæˆï¼ä¸»è¦æˆå°±ï¼š

1. âœ… æ‰€æœ‰è¡¨ç»“æ„å®Œæ•´
2. âœ… æ”¶æ¬¾äºŒç»´ç æ•°æ®å·²æ’å…¥
3. âœ… Storage Buckets å·²åˆ›å»º
4. âœ… Edge Functions å…¨éƒ¨éƒ¨ç½²
5. âœ… æ•°æ®åº“è¿ç§»å·²åº”ç”¨

**ç°åœ¨åªéœ€è¦ä½ ä¸Šä¼ æ”¶æ¬¾äºŒç»´ç å›¾ç‰‡ï¼Œé…ç½®å¾®ä¿¡ Secretsï¼Œå°±å¯ä»¥å¼€å§‹æµ‹è¯•äº†ï¼**

å……å€¼åŠŸèƒ½å’Œä»˜æ¬¾æˆªå›¾ä¸Šä¼ åŠŸèƒ½éƒ½å·²ç»å‡†å¤‡å°±ç»ªã€‚ğŸ‰
